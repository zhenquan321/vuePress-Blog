(window.webpackJsonp=window.webpackJsonp||[]).push([[98],{422:function(s,t,n){"use strict";n.r(t);var a=n(43),e=Object(a.a)({},function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"event-loop详解"}},[s._v("Event Loop详解")]),s._v(" "),n("blockquote",[n("p",[s._v("本文是"),n("a",{attrs:{href:"https://juejin.im/post/5c3d8956e51d4511dc72c200?utm_source=gold_browser_extension#comment",target:"_blank",rel:"noopener noreferrer"}},[s._v("弄懂Event Loop"),n("OutboundLink")],1),s._v("的删改版，去除了原文中一些容易引起歧义的部分，对一些内容进行了扩充")])]),s._v(" "),n("h2",{attrs:{id:"前言"}},[s._v("前言")]),s._v(" "),n("p",[n("code",[s._v("Event Loop")]),s._v("即事件循环，是指浏览器或"),n("code",[s._v("Node")]),s._v("的一种解决"),n("code",[s._v("javaScript")]),s._v("单线程运行时不会阻塞的一种机制，也就是我们经常使用"),n("strong",[s._v("异步")]),s._v("的原理。\n"),n("a",{attrs:{name:"Kec8C"}})]),s._v(" "),n("h2",{attrs:{id:"为啥要弄懂event-loop"}},[s._v("为啥要弄懂Event Loop")]),s._v(" "),n("ul",[n("li",[s._v("是要增加自己技术的深度，也就是懂得"),n("code",[s._v("JavaScript")]),s._v("的运行机制。"),n("br")]),s._v(" "),n("li",[s._v("现在在前端领域各种技术层出不穷，掌握底层原理，可以让自己以不变，应万变。"),n("br")]),s._v(" "),n("li",[s._v("应对各大互联网公司的面试，懂其原理，题目任其发挥。"),n("br"),s._v(" "),n("a",{attrs:{name:"52BT4"}})])]),s._v(" "),n("h2",{attrs:{id:"栈、队列的基本概念"}},[s._v("栈、队列的基本概念")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995437042-9d683636-9bf5-45fb-8cf3-e482b94a707d.webp#align=left&display=inline&height=271&originHeight=271&originWidth=294&size=0&status=done&width=294",alt:""}})]),s._v(" "),n("h3",{attrs:{id:"栈（stack）"}},[s._v("栈（Stack）")]),s._v(" "),n("p",[n("strong",[s._v("栈")]),s._v("在计算机科学中是限定仅在"),n("strong",[s._v("表尾")]),s._v("进行"),n("strong",[s._v("插入")]),s._v("或"),n("strong",[s._v("删除")]),s._v("操作的线性表。 "),n("strong",[s._v("栈")]),s._v("是一种数据结构，它按照"),n("strong",[s._v("后进先出")]),s._v("的原则存储数据，"),n("strong",[s._v("先进入")]),s._v("的数据被压入"),n("strong",[s._v("栈底")]),s._v("，"),n("strong",[s._v("最后的数据")]),s._v("在"),n("strong",[s._v("栈顶")]),s._v("，需要读数据的时候从"),n("strong",[s._v("栈顶")]),s._v("开始"),n("strong",[s._v("弹出数据")]),s._v("。"),n("br"),n("strong",[s._v("栈")]),s._v("是只能在"),n("strong",[s._v("某一端插入")]),s._v("和"),n("strong",[s._v("删除")]),s._v("的"),n("strong",[s._v("特殊线性表")]),s._v("。"),n("br"),n("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995436902-6dcf8420-be5b-4dd9-9fb6-43e567e53c86.webp#align=left&display=inline&height=282&originHeight=282&originWidth=616&size=0&status=done&width=616",alt:""}}),s._v(" "),n("a",{attrs:{name:"Dao1u"}})]),s._v(" "),n("h3",{attrs:{id:"队列（queue）"}},[s._v("队列（Queue）")]),s._v(" "),n("p",[s._v("特殊之处在于它只允许在表的前端（"),n("code",[s._v("front")]),s._v("）进行"),n("strong",[s._v("删除")]),s._v("操作，而在表的后端（"),n("code",[s._v("rear")]),s._v("）进行"),n("strong",[s._v("插入")]),s._v("操作，和"),n("strong",[s._v("栈")]),s._v("一样，"),n("strong",[s._v("队列")]),s._v("是一种操作受限制的线性表。"),n("br"),s._v("进行"),n("strong",[s._v("插入")]),s._v("操作的端称为"),n("strong",[s._v("队尾")]),s._v("，进行"),n("strong",[s._v("删除")]),s._v("操作的端称为"),n("strong",[s._v("队头")]),s._v("。 队列中没有元素时，称为"),n("strong",[s._v("空队列")]),s._v("。"),n("br"),n("strong",[s._v("队列")]),s._v("的数据元素又称为"),n("strong",[s._v("队列元素")]),s._v("。在队列中插入一个队列元素称为"),n("strong",[s._v("入队")]),s._v("，从"),n("strong",[s._v("队列")]),s._v("中"),n("strong",[s._v("删除")]),s._v("一个队列元素称为"),n("strong",[s._v("出队")]),s._v("。因为队列"),n("strong",[s._v("只允许")]),s._v("在一端"),n("strong",[s._v("插入")]),s._v("，在另一端"),n("strong",[s._v("删除")]),s._v("，所以只有"),n("strong",[s._v("最早")]),s._v("进入"),n("strong",[s._v("队列")]),s._v("的元素"),n("strong",[s._v("才能最先从队列中")]),s._v("删除，故队列又称为"),n("strong",[s._v("先进先出")]),s._v("（"),n("code",[s._v("FIFO—first in first out")]),s._v("）"),n("br"),n("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995436932-57cb6ee5-763a-47b2-a0be-4174c4fd1c66.webp#align=left&display=inline&height=270&originHeight=270&originWidth=554&size=0&status=done&width=554",alt:""}}),s._v(" "),n("a",{attrs:{name:"DE6Ak"}})]),s._v(" "),n("h2",{attrs:{id:"event-loop"}},[s._v("Event Loop")]),s._v(" "),n("p",[s._v("在"),n("code",[s._v("JavaScript")]),s._v("中，任务被分为两种，一种宏任务（"),n("code",[s._v("MacroTask")]),s._v("）也叫"),n("code",[s._v("Task")]),s._v("，一种叫微任务（"),n("code",[s._v("MicroTask")]),s._v("）。\n"),n("a",{attrs:{name:"JQeJU"}})]),s._v(" "),n("h3",{attrs:{id:"macrotask（宏任务）"}},[s._v("MacroTask（宏任务）")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("script")]),s._v("全部代码、"),n("code",[s._v("setTimeout")]),s._v("、"),n("code",[s._v("setInterval")]),s._v("、"),n("code",[s._v("setImmediate")]),s._v("（浏览器暂时不支持，只有IE10支持，具体可见"),n("a",{attrs:{href:"https://link.juejin.im/?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FWindow%2FsetImmediate",target:"_blank",rel:"noopener noreferrer"}},[n("code",[s._v("MDN")]),n("OutboundLink")],1),s._v("）、"),n("code",[s._v("I/O")]),s._v("、"),n("code",[s._v("UI Rendering")]),s._v("。\n"),n("a",{attrs:{name:"zG8N7"}})])]),s._v(" "),n("h3",{attrs:{id:"microtask（微任务）"}},[s._v("MicroTask（微任务）")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("Process.nextTick（Node独有）")]),s._v("、"),n("code",[s._v("Promise")]),s._v("、"),n("code",[s._v("Object.observe(废弃)")]),s._v("、"),n("code",[s._v("MutationObserver")]),s._v("（具体使用方式查看"),n("a",{attrs:{href:"https://link.juejin.im/?target=http%3A%2F%2Fjavascript.ruanyifeng.com%2Fdom%2Fmutationobserver.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("这里"),n("OutboundLink")],1),s._v("）\n"),n("a",{attrs:{name:"EvaCF"}})])]),s._v(" "),n("h2",{attrs:{id:"浏览器中的event-loop"}},[s._v("浏览器中的Event Loop")]),s._v(" "),n("p",[n("code",[s._v("Javascript")]),s._v(" 有一个 "),n("code",[s._v("main thread")]),s._v(" 主线程和 "),n("code",[s._v("call-stack")]),s._v(" 调用栈(执行栈)，所有的任务都会被放到调用栈等待主线程执行。\n"),n("a",{attrs:{name:"GyyZL"}})]),s._v(" "),n("h3",{attrs:{id:"js调用栈"}},[s._v("JS调用栈")]),s._v(" "),n("p",[s._v("JS调用栈采用的是后进先出的规则，当函数执行的时候，会被添加到栈的顶部，当执行栈执行完成后，就会从栈顶移出，直到栈内被清空。\n"),n("a",{attrs:{name:"Hv5X9"}})]),s._v(" "),n("h3",{attrs:{id:"同步任务和异步任务"}},[s._v("同步任务和异步任务")]),s._v(" "),n("p",[n("code",[s._v("Javascript")]),s._v("单线程任务被分为"),n("strong",[s._v("同步任务")]),s._v("和"),n("strong",[s._v("异步任务")]),s._v("，同步任务会在调用栈中按照顺序等待主线程依次执行，异步任务会在异步任务有了结果后，将注册的回调函数放入任务队列中等待主线程空闲的时候（调用栈被清空），被读取到栈内等待主线程的执行。"),n("br"),n("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995436925-9ac8fb38-4dfd-4d12-b5fe-c564ede43f80.webp#align=left&display=inline&height=518&originHeight=518&originWidth=636&size=0&status=done&width=636",alt:""}}),s._v("任务队列"),n("code",[s._v("Task Queue")]),s._v("，即队列，是一种先进先出的一种数据结构。"),n("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995437021-43545b5b-0a48-475a-a8a6-cce80433fe1a.webp#align=left&display=inline&height=669&originHeight=669&originWidth=800&size=0&status=done&width=800",alt:""}}),s._v(" "),n("a",{attrs:{name:"gn45S"}})]),s._v(" "),n("h3",{attrs:{id:"事件循环的进程模型"}},[s._v("事件循环的进程模型")]),s._v(" "),n("ul",[n("li",[s._v("选择当前要执行的任务队列，选择任务队列中最先进入的任务，如果任务队列为空即"),n("code",[s._v("null")]),s._v("，则执行跳转到微任务（"),n("code",[s._v("MicroTask")]),s._v("）的执行步骤。")]),s._v(" "),n("li",[s._v("将事件循环中的任务设置为已选择任务。")]),s._v(" "),n("li",[s._v("执行任务。")]),s._v(" "),n("li",[s._v("将事件循环中当前运行任务设置为null。")]),s._v(" "),n("li",[s._v("将已经运行完成的任务从任务队列中删除。")]),s._v(" "),n("li",[s._v("microtasks步骤：进入microtask检查点。")]),s._v(" "),n("li",[s._v("更新界面渲染。")]),s._v(" "),n("li",[s._v("返回第一步。\n"),n("a",{attrs:{name:"axvjy"}})])]),s._v(" "),n("h3",{attrs:{id:"执行进入microtask检查点时，用户代理会执行以下步骤："}},[s._v("执行进入microtask检查点时，用户代理会执行以下步骤：")]),s._v(" "),n("ul",[n("li",[s._v("设置microtask检查点标志为true。")]),s._v(" "),n("li",[s._v("当事件循环"),n("code",[s._v("microtask")]),s._v("执行不为空时：选择一个最先进入的"),n("code",[s._v("microtask")]),s._v("队列的"),n("code",[s._v("microtask")]),s._v("，将事件循环的"),n("code",[s._v("microtask")]),s._v("设置为已选择的"),n("code",[s._v("microtask")]),s._v("，运行"),n("code",[s._v("microtask")]),s._v("，将已经执行完成的"),n("code",[s._v("microtask")]),s._v("为"),n("code",[s._v("null")]),s._v("，移出"),n("code",[s._v("microtask")]),s._v("中的"),n("code",[s._v("microtask")]),s._v("。")]),s._v(" "),n("li",[s._v("清理IndexDB事务")]),s._v(" "),n("li",[s._v("设置进入microtask检查点的标志为false。")])]),s._v(" "),n("p",[s._v("上述可能不太好理解，下图是我做的一张图片。"),n("br"),n("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/gif/128853/1560995436931-71f56a41-54d3-49f3-a382-c1e6acbf301e.gif#align=left&display=inline&height=589&originHeight=589&originWidth=1011&size=0&status=done&width=1011",alt:""}}),n("br"),s._v("执行栈在执行完"),n("strong",[s._v("同步任务")]),s._v("后，查看"),n("strong",[s._v("执行栈")]),s._v("是否为空，如果执行栈为空，就会去检查"),n("strong",[s._v("微任务")]),s._v("("),n("code",[s._v("microTask")]),s._v(")队列是否为空，如果为空的话，就执行"),n("code",[s._v("Task")]),s._v("（宏任务），否则就一次性执行完所有微任务。"),n("br"),s._v("每次单个"),n("strong",[s._v("宏任务")]),s._v("执行完毕后，检查"),n("strong",[s._v("微任务")]),s._v("("),n("code",[s._v("microTask")]),s._v(")队列是否为空，如果不为空的话，会按照"),n("strong",[s._v("先入先")]),s._v("出的规则全部执行完"),n("strong",[s._v("微任务")]),s._v("("),n("code",[s._v("microTask")]),s._v(")后，设置"),n("strong",[s._v("微任务")]),s._v("("),n("code",[s._v("microTask")]),s._v(")队列为"),n("code",[s._v("null")]),s._v("，然后再执行"),n("strong",[s._v("宏任务")]),s._v("，如此循环。\n"),n("a",{attrs:{name:"rd9zs"}})]),s._v(" "),n("h2",{attrs:{id:"举个例子"}},[s._v("举个例子")]),s._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[s._v("console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'script start'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'setTimeout'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nPromise"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'promise1'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'promise2'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'script end'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("p",[s._v("首先我们划分几个分类：\n"),n("a",{attrs:{name:"Phe8h"}})]),s._v(" "),n("h3",{attrs:{id:"第一次执行："}},[s._v("第一次执行：")]),s._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[s._v("Tasks：run script、 setTimeout callback\nMicrotasks：Promise then\t\n"),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("JS")]),s._v(" stack"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" script\t\nLog"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" script start、script end。\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("执行同步代码，将宏任务（"),n("code",[s._v("Tasks")]),s._v("）和微任务("),n("code",[s._v("Microtasks")]),s._v(")划分到各自队列中。\n"),n("a",{attrs:{name:"GZaz9"}})]),s._v(" "),n("h3",{attrs:{id:"第二次执行："}},[s._v("第二次执行：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("Tasks：run script、 setTimeout callback\nMicrotasks：Promise2 then\t\nJS stack: Promise2 callback\t\nLog: script start、script end、promise1、promise2\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("执行宏任务后，检测到微任务("),n("code",[s._v("Microtasks")]),s._v(")队列中不为空，执行"),n("code",[s._v("Promise1")]),s._v("，执行完成"),n("code",[s._v("Promise1")]),s._v("后，调用"),n("code",[s._v("Promise2.then")]),s._v("，放入微任务("),n("code",[s._v("Microtasks")]),s._v(")队列中，再执行"),n("code",[s._v("Promise2.then")]),s._v("。\n"),n("a",{attrs:{name:"6OrDB"}})]),s._v(" "),n("h3",{attrs:{id:"第三次执行："}},[s._v("第三次执行：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("Tasks：setTimeout callback\nMicrotasks：\t\nJS stack: setTimeout callback\nLog: script start、script end、promise1、promise2、setTimeout\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("当微任务("),n("code",[s._v("Microtasks")]),s._v(")队列中为空时，执行宏任务（"),n("code",[s._v("Tasks")]),s._v("），执行"),n("code",[s._v("setTimeout callback")]),s._v("，打印日志。\n"),n("a",{attrs:{name:"h3YfH"}})]),s._v(" "),n("h3",{attrs:{id:"第四次执行："}},[s._v("第四次执行：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("Tasks：setTimeout callback\nMicrotasks：\t\nJS stack: \nLog: script start、script end、promise1、promise2、setTimeout\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("清空"),n("strong",[s._v("Tasks")]),s._v("队列和"),n("code",[s._v("JS stack")]),s._v("。"),n("br"),s._v("以上执行帧动画可以查看"),n("a",{attrs:{href:"https://link.juejin.im/?target=https%3A%2F%2Fjakearchibald.com%2F2015%2Ftasks-microtasks-queues-and-schedules%2F",target:"_blank",rel:"noopener noreferrer"}},[s._v("Tasks, microtasks, queues and schedules"),n("OutboundLink")],1),n("br"),s._v("或许这张图也更好理解些。"),n("br"),n("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/gif/128853/1560995436968-c6ff2732-4b20-49d4-852f-8c298eeb0d2e.gif#align=left&display=inline&height=341&originHeight=341&originWidth=611&size=0&status=done&width=611",alt:""}}),s._v(" "),n("a",{attrs:{name:"SmhP7"}})]),s._v(" "),n("h2",{attrs:{id:"再举个例子"}},[s._v("再举个例子")]),s._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[s._v("console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'script start'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("async1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("await")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("async2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'async1 end'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("async2")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'async2 end'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" \n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("async1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'setTimeout'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Promise")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("resolve "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Promise'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'promise1'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'promise2'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'script end'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br")])]),n("p",[s._v("这里需要先理解"),n("code",[s._v("async/await")]),s._v("。"),n("br"),n("code",[s._v("async/await")]),s._v(" 在底层转换成了 "),n("code",[s._v("promise")]),s._v(" 和 "),n("code",[s._v("then")]),s._v(" 回调函数。"),n("br"),s._v("也就是说，这是 "),n("code",[s._v("promise")]),s._v(" 的语法糖。"),n("br"),s._v("每次我们使用 "),n("code",[s._v("await")]),s._v(", 解释器都创建一个 "),n("code",[s._v("promise")]),s._v(" 对象，然后把剩下的 "),n("code",[s._v("async")]),s._v(" 函数中的操作放到 "),n("code",[s._v("then")]),s._v(" 回调函数中。"),n("br"),n("code",[s._v("async/await")]),s._v(" 的实现，离不开 "),n("code",[s._v("Promise")]),s._v("。从字面意思来理解，"),n("code",[s._v("async")]),s._v(" 是“异步”的简写，而 "),n("code",[s._v("await")]),s._v(" 是 "),n("code",[s._v("async wait")]),s._v(" 的简写可以认为是等待异步方法执行完成。\n"),n("a",{attrs:{name:"LRx9h"}})]),s._v(" "),n("h3",{attrs:{id:"关于73以下版本和73版本的区别"}},[n("strong",[s._v("关于73以下版本和73版本的区别")])]),s._v(" "),n("ul",[n("li",[s._v("在老版本版本以下，先执行"),n("code",[s._v("promise1")]),s._v("和"),n("code",[s._v("promise2")]),s._v("，再执行"),n("code",[s._v("async1")]),s._v("。")]),s._v(" "),n("li",[s._v("在73版本，先执行"),n("code",[s._v("async1")]),s._v("再执行"),n("code",[s._v("promise1")]),s._v("和"),n("code",[s._v("promise2")]),s._v("。")])]),s._v(" "),n("p",[n("strong",[s._v("主要原因是因为在谷歌(金丝雀)73版本中更改了规范，如下图所示：")]),n("br"),n("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995436973-49daab42-3959-4cb2-9417-30a651fedf80.webp#align=left&display=inline&height=243&originHeight=243&originWidth=668&size=0&status=done&width=668",alt:""}})]),s._v(" "),n("ul",[n("li",[s._v("区别在于"),n("code",[s._v("RESOLVE(thenable)")]),s._v("和之间的区别"),n("code",[s._v("Promise.resolve(thenable)")]),s._v("。\n"),n("a",{attrs:{name:"lE9S0"}})])]),s._v(" "),n("h3",{attrs:{id:"在老版本中"}},[n("strong",[s._v("在老版本中")])]),s._v(" "),n("ul",[n("li",[s._v("首先，传递给 "),n("code",[s._v("await")]),s._v(" 的值被包裹在一个 "),n("code",[s._v("Promise")]),s._v(" 中。然后，处理程序附加到这个包装的 "),n("code",[s._v("Promise")]),s._v("，以便在 "),n("code",[s._v("Promise")]),s._v(" 变为 "),n("code",[s._v("fulfilled")]),s._v(" 后恢复该函数，并且暂停执行异步函数，一旦 "),n("code",[s._v("promise")]),s._v(" 变为 "),n("code",[s._v("fulfilled")]),s._v("，恢复异步函数的执行。")]),s._v(" "),n("li",[s._v("每个 "),n("code",[s._v("await")]),s._v(" 引擎必须创建两个额外的 Promise（即使右侧已经是一个 "),n("code",[s._v("Promise")]),s._v("）并且它需要至少三个 "),n("code",[s._v("microtask")]),s._v(" 队列 "),n("code",[s._v("ticks")]),s._v("（"),n("code",[s._v("tick")]),s._v("为系统的相对时间单位，也被称为系统的时基，来源于定时器的周期性中断（输出脉冲），一次中断表示一个"),n("code",[s._v("tick")]),s._v("，也被称做一个“时钟滴答”、时标。）。\n"),n("a",{attrs:{name:"1I6ks"}})])]),s._v(" "),n("h3",{attrs:{id:"引用贺老师知乎上的一个例子"}},[n("strong",[s._v("引用贺老师知乎上的一个例子")])]),s._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("f")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("await")]),s._v(" p\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ok'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("简化理解为：")]),s._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("f")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("RESOLVE")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("p"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ok'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("ul",[n("li",[s._v("如果 "),n("code",[s._v("RESOLVE(p)")]),s._v(" 对于 "),n("code",[s._v("p")]),s._v(" 为 "),n("code",[s._v("promise")]),s._v(" 直接返回 "),n("code",[s._v("p")]),s._v(" 的话，那么 "),n("code",[s._v("p")]),s._v("的 "),n("code",[s._v("then")]),s._v(" 方法就会被马上调用，其回调就立即进入 "),n("code",[s._v("job")]),s._v(" 队列。")]),s._v(" "),n("li",[s._v("而如果 "),n("code",[s._v("RESOLVE(p)")]),s._v(" 严格按照标准，应该是产生一个新的 "),n("code",[s._v("promise")]),s._v("，尽管该 "),n("code",[s._v("promise")]),s._v("确定会 "),n("code",[s._v("resolve")]),s._v(" 为 "),n("code",[s._v("p")]),s._v("，但这个过程本身是异步的，也就是现在进入 "),n("code",[s._v("job")]),s._v(" 队列的是新 "),n("code",[s._v("promise")]),s._v("的 "),n("code",[s._v("resolve")]),s._v("过程，所以该 "),n("code",[s._v("promise")]),s._v(" 的 "),n("code",[s._v("then")]),s._v(" 不会被立即调用，而要等到当前 "),n("code",[s._v("job")]),s._v(" 队列执行到前述 "),n("code",[s._v("resolve")]),s._v(" 过程才会被调用，然后其回调（也就是继续 "),n("code",[s._v("await")]),s._v(" 之后的语句）才加入 "),n("code",[s._v("job")]),s._v(" 队列，所以时序上就晚了。\n"),n("a",{attrs:{name:"XRpkE"}})])]),s._v(" "),n("h3",{attrs:{id:"谷歌（金丝雀）73版本中"}},[n("strong",[s._v("谷歌（金丝雀）73版本中")])]),s._v(" "),n("ul",[n("li",[s._v("使用对"),n("code",[s._v("PromiseResolve")]),s._v("的调用来更改"),n("code",[s._v("await")]),s._v("的语义，以减少在公共"),n("code",[s._v("awaitPromise")]),s._v("情况下的转换次数。")]),s._v(" "),n("li",[s._v("如果传递给 "),n("code",[s._v("await")]),s._v(" 的值已经是一个 "),n("code",[s._v("Promise")]),s._v("，那么这种优化避免了再次创建 "),n("code",[s._v("Promise")]),s._v(" 包装器，在这种情况下，我们从最少三个 "),n("code",[s._v("microtick")]),s._v(" 到只有一个 "),n("code",[s._v("microtick")]),s._v("。\n"),n("a",{attrs:{name:"kbGWS"}})])]),s._v(" "),n("h3",{attrs:{id:"详细过程："}},[n("strong",[s._v("详细过程：")])]),s._v(" "),n("p",[n("strong",[s._v("73以下版本")])]),s._v(" "),n("ul",[n("li",[s._v("首先，打印"),n("code",[s._v("script start")]),s._v("，调用"),n("code",[s._v("async1()")]),s._v("时，返回一个"),n("code",[s._v("Promise")]),s._v("，所以打印出来"),n("code",[s._v("async2 end")]),s._v("。")]),s._v(" "),n("li",[s._v("每个 "),n("code",[s._v("await")]),s._v("，会新产生一个"),n("code",[s._v("promise")]),s._v(",但这个过程本身是异步的，所以该"),n("code",[s._v("await")]),s._v("后面不会立即调用。")]),s._v(" "),n("li",[s._v("继续执行同步代码，打印"),n("code",[s._v("Promise")]),s._v("和"),n("code",[s._v("script end")]),s._v("，将"),n("code",[s._v("then")]),s._v("函数放入"),n("strong",[s._v("微任务")]),s._v("队列中等待执行。")]),s._v(" "),n("li",[s._v("同步执行完成之后，检查"),n("strong",[s._v("微任务")]),s._v("队列是否为"),n("code",[s._v("null")]),s._v("，然后按照先入先出规则，依次执行。")]),s._v(" "),n("li",[s._v("然后先执行打印"),n("code",[s._v("promise1")]),s._v(",此时"),n("code",[s._v("then")]),s._v("的回调函数返回"),n("code",[s._v("undefinde")]),s._v("，此时又有"),n("code",[s._v("then")]),s._v("的链式调用，又放入"),n("strong",[s._v("微任务")]),s._v("队列中，再次打印"),n("code",[s._v("promise2")]),s._v("。")]),s._v(" "),n("li",[s._v("再回到"),n("code",[s._v("await")]),s._v("的位置执行返回的 "),n("code",[s._v("Promise")]),s._v(" 的 "),n("code",[s._v("resolve")]),s._v(" 函数，这又会把 "),n("code",[s._v("resolve")]),s._v(" 丢到微任务队列中，打印"),n("code",[s._v("async1 end")]),s._v("。")]),s._v(" "),n("li",[s._v("当"),n("strong",[s._v("微任务")]),s._v("队列为空时，执行宏任务,打印"),n("code",[s._v("setTimeout")]),s._v("。")])]),s._v(" "),n("p",[n("strong",[s._v("谷歌（金丝雀73版本）")])]),s._v(" "),n("ul",[n("li",[s._v("如果传递给 "),n("code",[s._v("await")]),s._v(" 的值已经是一个 "),n("code",[s._v("Promise")]),s._v("，那么这种优化避免了再次创建 "),n("code",[s._v("Promise")]),s._v(" 包装器，在这种情况下，我们从最少三个 "),n("code",[s._v("microtick")]),s._v(" 到只有一个 "),n("code",[s._v("microtick")]),s._v("。")]),s._v(" "),n("li",[s._v("引擎不再需要为 "),n("code",[s._v("await")]),s._v(" 创造 "),n("code",[s._v("throwaway Promise")]),s._v(" - 在绝大部分时间。")]),s._v(" "),n("li",[s._v("现在 "),n("code",[s._v("promise")]),s._v(" 指向了同一个 "),n("code",[s._v("Promise")]),s._v("，所以这个步骤什么也不需要做。然后引擎继续像以前一样，创建 "),n("code",[s._v("throwaway Promise")]),s._v("，安排 "),n("code",[s._v("PromiseReactionJob")]),s._v(" 在 "),n("code",[s._v("microtask")]),s._v(" 队列的下一个 "),n("code",[s._v("tick")]),s._v(" 上恢复异步函数，暂停执行该函数，然后返回给调用者。")])]),s._v(" "),n("p",[s._v("具体详情查看（"),n("a",{attrs:{href:"https://link.juejin.im/?target=https%3A%2F%2Fv8.js.cn%2Fblog%2Ffast-async%2F",target:"_blank",rel:"noopener noreferrer"}},[s._v("这里"),n("OutboundLink")],1),s._v("）。\n"),n("a",{attrs:{name:"lXMku"}})]),s._v(" "),n("h2",{attrs:{id:"nodejs的event-loop"}},[s._v("NodeJS的Event Loop")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995436966-ae34b24c-83d0-4472-8854-1552abd9fcdb.webp#align=left&display=inline&height=223&originHeight=223&originWidth=543&size=0&status=done&width=543",alt:""}}),n("br"),n("code",[s._v("Node")]),s._v("中的"),n("code",[s._v("Event Loop")]),s._v("是基于"),n("code",[s._v("libuv")]),s._v("实现的，而"),n("code",[s._v("libuv")]),s._v("是 "),n("code",[s._v("Node")]),s._v(" 的新跨平台抽象层，libuv使用异步，事件驱动的编程方式，核心是提供"),n("code",[s._v("i/o")]),s._v("的事件循环和异步回调。libuv的"),n("code",[s._v("API")]),s._v("包含有时间，非阻塞的网络，异步文件操作，子进程等等。 "),n("code",[s._v("Event Loop")]),s._v("就是在"),n("code",[s._v("libuv")]),s._v("中实现的。"),n("br"),n("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995436946-e5bcfbd1-340e-4c68-a14e-cd000081eef4.webp#align=left&display=inline&height=442&originHeight=442&originWidth=745&size=0&status=done&width=745",alt:""}}),s._v(" "),n("a",{attrs:{name:"4clmy"}})]),s._v(" "),n("h3",{attrs:{id:"node的event-loop一共分为6个阶段，每个细节具体如下："}},[n("code",[s._v("Node")]),s._v("的"),n("code",[s._v("Event loop")]),s._v("一共分为6个阶段，每个细节具体如下：")]),s._v(" "),n("ul",[n("li",[n("code",[s._v("timers")]),s._v(": 执行"),n("code",[s._v("setTimeout")]),s._v("和"),n("code",[s._v("setInterval")]),s._v("中到期的"),n("code",[s._v("callback")]),s._v("。")]),s._v(" "),n("li",[n("code",[s._v("pending callback")]),s._v(": 上一轮循环中少数的"),n("code",[s._v("callback")]),s._v("会放在这一阶段执行。")]),s._v(" "),n("li",[n("code",[s._v("idle, prepare")]),s._v(": 仅在内部使用。")]),s._v(" "),n("li",[n("code",[s._v("poll")]),s._v(": 最重要的阶段，执行"),n("code",[s._v("pending callback")]),s._v("，在适当的情况下回阻塞在这个阶段。")]),s._v(" "),n("li",[n("code",[s._v("check")]),s._v(": 执行"),n("code",[s._v("setImmediate")]),s._v("("),n("code",[s._v("setImmediate()")]),s._v("是将事件插入到事件队列尾部，主线程和事件队列的函数执行完成之后立即执行"),n("code",[s._v("setImmediate")]),s._v("指定的回调函数)的"),n("code",[s._v("callback")]),s._v("。")]),s._v(" "),n("li",[n("code",[s._v("close callbacks")]),s._v(": 执行"),n("code",[s._v("close")]),s._v("事件的"),n("code",[s._v("callback")]),s._v("，例如"),n("code",[s._v("socket.on('close'[,fn])")]),s._v("或者"),n("code",[s._v("http.server.on('close, fn)")]),s._v("。")])]),s._v(" "),n("p",[s._v("具体细节如下：\n"),n("a",{attrs:{name:"qYgPm"}})]),s._v(" "),n("h3",{attrs:{id:"timers"}},[s._v("timers")]),s._v(" "),n("p",[s._v("执行"),n("code",[s._v("setTimeout")]),s._v("和"),n("code",[s._v("setInterval")]),s._v("中到期的"),n("code",[s._v("callback")]),s._v("，执行这两者回调需要设置一个毫秒数，理论上来说，应该是时间一到就立即执行callback回调，但是由于"),n("code",[s._v("system")]),s._v("的调度可能会延时，达不到预期时间。"),n("br"),s._v("以下是官网文档解释的例子：")]),s._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" fs "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'fs'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("someAsyncOperation")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("callback"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Assume this takes 95ms to complete")]),s._v("\n  fs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("readFile")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/path/to/file'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" callback"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" timeoutScheduled "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Date"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("now")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" delay "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Date"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("now")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" timeoutScheduled"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token template-string"}},[n("span",{pre:!0,attrs:{class:"token string"}},[s._v("`")]),n("span",{pre:!0,attrs:{class:"token interpolation"}},[n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[s._v("${")]),s._v("delay"),n("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[s._v("}")])]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("ms have passed since I was scheduled`")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// do someAsyncOperation which takes 95 ms to complete")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("someAsyncOperation")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" startCallback "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Date"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("now")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// do something that will take 10ms...")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Date"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("now")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" startCallback "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// do nothing")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("p",[s._v("当进入事件循环时，它有一个空队列（"),n("code",[s._v("fs.readFile()")]),s._v("尚未完成），因此定时器将等待剩余毫秒数，当到达95ms时，"),n("code",[s._v("fs.readFile()")]),s._v("完成读取文件并且其完成需要10毫秒的回调被添加到轮询队列并执行。"),n("br"),s._v("当回调结束时，队列中不再有回调，因此事件循环将看到已达到最快定时器的"),n("strong",[s._v("阈值")]),s._v("，然后回到"),n("strong",[s._v("timers阶段")]),s._v("以执行定时器的回调。"),n("br"),s._v("在此示例中，您将看到正在调度的计时器与正在执行的回调之间的总延迟将为105毫秒。"),n("br"),n("strong",[s._v("以下是我测试时间：")]),n("br"),n("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995436982-2f817b92-3c4a-4d4c-8f95-92f63efa336c.webp#align=left&display=inline&height=430&originHeight=430&originWidth=724&size=0&status=done&width=724",alt:""}}),s._v(" "),n("a",{attrs:{name:"sLxqs"}})]),s._v(" "),n("h3",{attrs:{id:"pending-callbacks"}},[s._v("pending callbacks")]),s._v(" "),n("p",[s._v("此阶段执行某些系统操作（例如TCP错误类型）的回调。 例如，如果"),n("code",[s._v("TCP socket ECONNREFUSED")]),s._v("在尝试connect时receives，则某些* nix系统希望等待报告错误。 这将在"),n("code",[s._v("pending callbacks")]),s._v("阶段执行。\n"),n("a",{attrs:{name:"3rwhp"}})]),s._v(" "),n("h3",{attrs:{id:"poll"}},[s._v("poll")]),s._v(" "),n("p",[n("strong",[s._v("该poll阶段有两个主要功能：")])]),s._v(" "),n("ul",[n("li",[s._v("执行"),n("code",[s._v("I/O")]),s._v("回调。")]),s._v(" "),n("li",[s._v("处理轮询队列中的事件。")])]),s._v(" "),n("p",[n("strong",[s._v("当事件循环进入"),n("code",[s._v("poll")]),s._v("阶段并且在"),n("code",[s._v("timers")]),s._v("中没有可以执行定时器时，将发生以下两种情况之一")])]),s._v(" "),n("ul",[n("li",[s._v("如果"),n("code",[s._v("poll")]),s._v("队列不为空，则事件循环将遍历其同步执行它们的"),n("code",[s._v("callback")]),s._v("队列，直到队列为空，或者达到"),n("code",[s._v("system-dependent")]),s._v("（系统相关限制）。")])]),s._v(" "),n("p",[n("strong",[s._v("如果"),n("code",[s._v("poll")]),s._v("队列为空，则会发生以下两种情况之一")])]),s._v(" "),n("ul",[n("li",[s._v("如果有"),n("code",[s._v("setImmediate()")]),s._v("回调需要执行，则会立即停止执行"),n("code",[s._v("poll")]),s._v("阶段并进入执行"),n("code",[s._v("check")]),s._v("阶段以执行回调。"),n("br")]),s._v(" "),n("li",[s._v("如果没有"),n("code",[s._v("setImmediate()")]),s._v("回到需要执行，poll阶段将等待"),n("code",[s._v("callback")]),s._v("被添加到队列中，然后立即执行。"),n("br")])]),s._v(" "),n("p",[n("strong",[s._v("当然设定了 timer 的话且 poll 队列为空，则会判断是否有 timer 超时，如果有的话会回到 timer 阶段执行回调。")]),s._v(" "),n("a",{attrs:{name:"aZTtj"}})]),s._v(" "),n("h3",{attrs:{id:"check"}},[s._v("check")]),s._v(" "),n("p",[n("strong",[s._v("此阶段允许人员在poll阶段完成后立即执行回调。")]),n("br"),s._v("如果"),n("code",[s._v("poll")]),s._v("阶段闲置并且"),n("code",[s._v("script")]),s._v("已排队"),n("code",[s._v("setImmediate()")]),s._v("，则事件循环到达check阶段执行而不是继续等待。"),n("br"),n("code",[s._v("setImmediate()")]),s._v("实际上是一个特殊的计时器，它在事件循环的一个单独阶段运行。它使用"),n("code",[s._v("libuv API")]),s._v("来调度在"),n("code",[s._v("poll")]),s._v("阶段完成后执行的回调。"),n("br"),s._v("通常，当代码被执行时，事件循环最终将达到"),n("code",[s._v("poll")]),s._v("阶段，它将等待传入连接，请求等。"),n("br"),s._v("但是，如果已经调度了回调"),n("code",[s._v("setImmediate()")]),s._v("，并且轮询阶段变为空闲，则它将结束并且到达"),n("code",[s._v("check")]),s._v("阶段，而不是等待"),n("code",[s._v("poll")]),s._v("事件。")]),s._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[s._v("console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'start'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'timer1'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  Promise"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'promise1'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'timer2'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  Promise"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'promise2'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nPromise"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'promise3'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nconsole"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'end'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("如果"),n("code",[s._v("node")]),s._v("版本为"),n("code",[s._v("v11.x")]),s._v("， 其结果与浏览器一致。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("start\nend\npromise3\ntimer1\npromise1\ntimer2\npromise2\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("具体详情可以查看《"),n("a",{attrs:{href:"https://juejin.im/post/5c3e8d90f265da614274218a",target:"_blank",rel:"noopener noreferrer"}},[s._v("又被node的eventloop坑了，这次是node的锅"),n("OutboundLink")],1),s._v("》。"),n("br"),s._v("如果v10版本上述结果存在两种情况：")]),s._v(" "),n("ul",[n("li",[s._v("如果time2定时器已经在执行队列中了")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("start\nend\npromise3\ntimer1\ntimer2\npromise1\npromise2\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("ul",[n("li",[s._v("如果time2定时器没有在执行对列中，执行结果为")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("start\nend\npromise3\ntimer1\npromise1\ntimer2\npromise2\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("具体情况可以参考"),n("code",[s._v("poll")]),s._v("阶段的两种情况。"),n("br"),s._v("从下图可能更好理解："),n("br"),n("img",{attrs:{src:"https://cdn.nlark.com/yuque/0/2019/gif/128853/1560995436960-165cb65c-477f-4b4c-8a0a-79d3136f342e.gif#align=left&display=inline&height=333&originHeight=333&originWidth=598&size=0&status=done&width=598",alt:""}}),s._v(" "),n("a",{attrs:{name:"K0Wcv"}})]),s._v(" "),n("h2",{attrs:{id:"setimmediate-的settimeout-的区别"}},[s._v("setImmediate() 的setTimeout()的区别")]),s._v(" "),n("p",[n("strong",[n("code",[s._v("setImmediate")]),s._v("和"),n("code",[s._v("setTimeout()")]),s._v("是相似的，但根据它们被调用的时间以不同的方式表现。")])]),s._v(" "),n("ul",[n("li",[n("code",[s._v("setImmediate()")]),s._v("设计用于在当前"),n("code",[s._v("poll")]),s._v("阶段完成后check阶段执行脚本 。")]),s._v(" "),n("li",[n("code",[s._v("setTimeout()")]),s._v(" 安排在经过最小（ms）后运行的脚本，在"),n("code",[s._v("timers")]),s._v("阶段执行。\n"),n("a",{attrs:{name:"k9uIW"}})])]),s._v(" "),n("h3",{attrs:{id:"举个例子-2"}},[s._v("举个例子")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("setTimeout(() => {\n  console.log('timeout');\n}, 0);\nsetImmediate(() => {\n  console.log('immediate');\n});\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[n("strong",[s._v("执行定时器的顺序将根据调用它们的上下文而有所不同。 如果从主模块中调用两者，那么时间将受到进程性能的限制。")]),n("br"),n("strong",[s._v("其结果也不一致")]),n("br"),n("strong",[s._v("如果在"),n("code",[s._v("I / O")]),s._v("周期内移动两个调用，则始终首先执行立即回调：")])]),s._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" fs "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'fs'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nfs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("readFile")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("__filename"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'timeout'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setImmediate")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'immediate'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("其结果可以确定一定是"),n("code",[s._v("immediate => timeout")]),s._v("。"),n("br"),s._v("主要原因是在"),n("code",[s._v("I/O阶段")]),s._v("读取文件后，事件循环会先进入"),n("code",[s._v("poll")]),s._v("阶段，发现有"),n("code",[s._v("setImmediate")]),s._v("需要执行，会立即进入"),n("code",[s._v("check")]),s._v("阶段执行"),n("code",[s._v("setImmediate")]),s._v("的回调。"),n("br"),s._v("然后再进入"),n("code",[s._v("timers")]),s._v("阶段，执行"),n("code",[s._v("setTimeout")]),s._v("，打印"),n("code",[s._v("timeout")]),s._v("。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("┌───────────────────────────┐\n┌─>│           timers          │\n│  └─────────────┬─────────────┘\n│  ┌─────────────┴─────────────┐\n│  │     pending callbacks     │\n│  └─────────────┬─────────────┘\n│  ┌─────────────┴─────────────┐\n│  │       idle, prepare       │\n│  └─────────────┬─────────────┘      ┌───────────────┐\n│  ┌─────────────┴─────────────┐      │   incoming:   │\n│  │           poll            │<─────┤  connections, │\n│  └─────────────┬─────────────┘      │   data, etc.  │\n│  ┌─────────────┴─────────────┐      └───────────────┘\n│  │           check           │\n│  └─────────────┬─────────────┘\n│  ┌─────────────┴─────────────┐\n└──┤      close callbacks      │\n   └───────────────────────────┘\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("p",[n("a",{attrs:{name:"YOs2k"}})]),s._v(" "),n("h2",{attrs:{id:"process-nexttick"}},[s._v("Process.nextTick()")]),s._v(" "),n("p",[n("strong",[n("code",[s._v("process.nextTick()")]),s._v("虽然它是异步API的一部分，但未在图中显示。这是因为"),n("code",[s._v("process.nextTick()")]),s._v("从技术上讲，它不是事件循环的一部分。")])]),s._v(" "),n("ul",[n("li",[n("code",[s._v("process.nextTick()")]),s._v("方法将 "),n("code",[s._v("callback")]),s._v(" 添加到"),n("code",[s._v("next tick")]),s._v("队列。 一旦当前事件轮询队列的任务全部完成，在"),n("code",[s._v("next tick")]),s._v("队列中的所有"),n("code",[s._v("callbacks")]),s._v("会被依次调用。")])]),s._v(" "),n("p",[n("strong",[s._v("换种理解方式：")])]),s._v(" "),n("ul",[n("li",[s._v("当每个阶段完成后，如果存在 "),n("code",[s._v("nextTick")]),s._v(" 队列，就会清空队列中的所有回调函数，并且优先于其他 "),n("code",[s._v("microtask")]),s._v(" 执行。\n"),n("a",{attrs:{name:"GCX3J"}})])]),s._v(" "),n("h3",{attrs:{id:"例子"}},[s._v("例子")]),s._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("let")]),s._v(" bar"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setTimeout")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'setTimeout'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("setImmediate")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'setImmediate'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("someAsyncApiCall")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("callback"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  process"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("nextTick")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("callback"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("someAsyncApiCall")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=>")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  console"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("log")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'bar'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" bar"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 1")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nbar "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("p",[s._v("在NodeV10中上述代码执行可能有两种答案，一种为：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("bar 1\nsetTimeout\nsetImmediate\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("另一种为：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("bar 1\nsetImmediate\nsetTimeout\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("无论哪种，始终都是先执行"),n("code",[s._v("process.nextTick(callback)")]),s._v("，打印"),n("code",[s._v("bar 1")]),s._v("。")]),s._v(" "),n("hr")])},[],!1,null,null,null);e.options.__file="eventLoop.md";t.default=e.exports}}]);