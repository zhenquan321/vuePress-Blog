<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>IO | 忙 · 南易</title>
    <meta name="description" content="">
    <link rel="apple-touch-icon" sizes="128x128" href="/favicon_128.ico">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/assets/css/0.styles.8c3d1e2d.css" as="style"><link rel="preload" href="/assets/js/app.239b68c1.js" as="script"><link rel="preload" href="/assets/js/4.d46d2a2b.js" as="script"><link rel="preload" href="/assets/js/55.8c60f9b3.js" as="script"><link rel="prefetch" href="/assets/js/10.b85db015.js"><link rel="prefetch" href="/assets/js/100.090b8e5b.js"><link rel="prefetch" href="/assets/js/101.bbb676d9.js"><link rel="prefetch" href="/assets/js/102.31f82669.js"><link rel="prefetch" href="/assets/js/103.3fb1b48a.js"><link rel="prefetch" href="/assets/js/104.80be1959.js"><link rel="prefetch" href="/assets/js/105.89cad783.js"><link rel="prefetch" href="/assets/js/106.cb6bd33d.js"><link rel="prefetch" href="/assets/js/107.c7d98004.js"><link rel="prefetch" href="/assets/js/108.9ca655c2.js"><link rel="prefetch" href="/assets/js/109.5e2ba8b1.js"><link rel="prefetch" href="/assets/js/11.8a5621e5.js"><link rel="prefetch" href="/assets/js/110.b867730c.js"><link rel="prefetch" href="/assets/js/111.242ec554.js"><link rel="prefetch" href="/assets/js/112.bbd310d2.js"><link rel="prefetch" href="/assets/js/113.2ba206f8.js"><link rel="prefetch" href="/assets/js/114.644edd11.js"><link rel="prefetch" href="/assets/js/115.a339d164.js"><link rel="prefetch" href="/assets/js/116.cf7458b9.js"><link rel="prefetch" href="/assets/js/117.e2e9ca56.js"><link rel="prefetch" href="/assets/js/118.7e01e661.js"><link rel="prefetch" href="/assets/js/119.7073a3db.js"><link rel="prefetch" href="/assets/js/12.8ca07f51.js"><link rel="prefetch" href="/assets/js/120.9c083d37.js"><link rel="prefetch" href="/assets/js/121.ac7f0ca1.js"><link rel="prefetch" href="/assets/js/122.64c5b517.js"><link rel="prefetch" href="/assets/js/123.8a0a80cb.js"><link rel="prefetch" href="/assets/js/124.b76549a6.js"><link rel="prefetch" href="/assets/js/125.02891ed0.js"><link rel="prefetch" href="/assets/js/126.a80fde29.js"><link rel="prefetch" href="/assets/js/127.9672de41.js"><link rel="prefetch" href="/assets/js/128.a8f89366.js"><link rel="prefetch" href="/assets/js/129.b3a2be2c.js"><link rel="prefetch" href="/assets/js/13.4f05305e.js"><link rel="prefetch" href="/assets/js/130.f5bbfe20.js"><link rel="prefetch" href="/assets/js/131.619a21f8.js"><link rel="prefetch" href="/assets/js/132.b01b8b37.js"><link rel="prefetch" href="/assets/js/133.4382d00b.js"><link rel="prefetch" href="/assets/js/14.5db8683e.js"><link rel="prefetch" href="/assets/js/15.6b87427e.js"><link rel="prefetch" href="/assets/js/16.e1fdb4cb.js"><link rel="prefetch" href="/assets/js/17.e8dfb0d0.js"><link rel="prefetch" href="/assets/js/18.9b867385.js"><link rel="prefetch" href="/assets/js/19.d3b46571.js"><link rel="prefetch" href="/assets/js/20.0bd7a691.js"><link rel="prefetch" href="/assets/js/21.f2ee9685.js"><link rel="prefetch" href="/assets/js/22.16c26579.js"><link rel="prefetch" href="/assets/js/23.f0774a27.js"><link rel="prefetch" href="/assets/js/24.290660c4.js"><link rel="prefetch" href="/assets/js/25.706f054c.js"><link rel="prefetch" href="/assets/js/26.6cfc93c6.js"><link rel="prefetch" href="/assets/js/27.6a7f220d.js"><link rel="prefetch" href="/assets/js/28.bd142947.js"><link rel="prefetch" href="/assets/js/29.a2b14612.js"><link rel="prefetch" href="/assets/js/3.818110a1.js"><link rel="prefetch" href="/assets/js/30.9f7add30.js"><link rel="prefetch" href="/assets/js/31.fc0eadbc.js"><link rel="prefetch" href="/assets/js/32.0972df93.js"><link rel="prefetch" href="/assets/js/33.78a10b29.js"><link rel="prefetch" href="/assets/js/34.f80e138d.js"><link rel="prefetch" href="/assets/js/35.f52d3dc4.js"><link rel="prefetch" href="/assets/js/36.e223d306.js"><link rel="prefetch" href="/assets/js/37.aeeb8e54.js"><link rel="prefetch" href="/assets/js/38.f65fd618.js"><link rel="prefetch" href="/assets/js/39.7e851236.js"><link rel="prefetch" href="/assets/js/40.d019d91b.js"><link rel="prefetch" href="/assets/js/41.c962b044.js"><link rel="prefetch" href="/assets/js/42.8cd2d4d1.js"><link rel="prefetch" href="/assets/js/43.d1549175.js"><link rel="prefetch" href="/assets/js/44.b108b4ff.js"><link rel="prefetch" href="/assets/js/45.3390da9f.js"><link rel="prefetch" href="/assets/js/46.b1a33f56.js"><link rel="prefetch" href="/assets/js/47.d9b28254.js"><link rel="prefetch" href="/assets/js/48.982bd1ea.js"><link rel="prefetch" href="/assets/js/49.3f86d8d4.js"><link rel="prefetch" href="/assets/js/5.93da9e01.js"><link rel="prefetch" href="/assets/js/50.2b473707.js"><link rel="prefetch" href="/assets/js/51.37a14f99.js"><link rel="prefetch" href="/assets/js/52.a9a5bf81.js"><link rel="prefetch" href="/assets/js/53.5df34f20.js"><link rel="prefetch" href="/assets/js/54.eee1fc68.js"><link rel="prefetch" href="/assets/js/56.4427e1a8.js"><link rel="prefetch" href="/assets/js/57.9a90a4bc.js"><link rel="prefetch" href="/assets/js/58.5989177f.js"><link rel="prefetch" href="/assets/js/59.5b9bee7d.js"><link rel="prefetch" href="/assets/js/6.ee63d877.js"><link rel="prefetch" href="/assets/js/60.9d11c5de.js"><link rel="prefetch" href="/assets/js/61.f8a874b8.js"><link rel="prefetch" href="/assets/js/62.5ae74cbf.js"><link rel="prefetch" href="/assets/js/63.860cbb55.js"><link rel="prefetch" href="/assets/js/64.91d218ca.js"><link rel="prefetch" href="/assets/js/65.cf09d12a.js"><link rel="prefetch" href="/assets/js/66.3e9ee600.js"><link rel="prefetch" href="/assets/js/67.efa5e577.js"><link rel="prefetch" href="/assets/js/68.c2dfb597.js"><link rel="prefetch" href="/assets/js/69.9ee476ed.js"><link rel="prefetch" href="/assets/js/7.9b9102dd.js"><link rel="prefetch" href="/assets/js/70.8d130c77.js"><link rel="prefetch" href="/assets/js/71.a10dbf8e.js"><link rel="prefetch" href="/assets/js/72.ae7c169f.js"><link rel="prefetch" href="/assets/js/73.d9a699cd.js"><link rel="prefetch" href="/assets/js/74.a1b1fcc0.js"><link rel="prefetch" href="/assets/js/75.cac138d8.js"><link rel="prefetch" href="/assets/js/76.41fe939b.js"><link rel="prefetch" href="/assets/js/77.d0a38d4e.js"><link rel="prefetch" href="/assets/js/78.75712491.js"><link rel="prefetch" href="/assets/js/79.21229e83.js"><link rel="prefetch" href="/assets/js/8.d1ef3d0e.js"><link rel="prefetch" href="/assets/js/80.e54b6c68.js"><link rel="prefetch" href="/assets/js/81.07a2f128.js"><link rel="prefetch" href="/assets/js/82.85dcf320.js"><link rel="prefetch" href="/assets/js/83.e66d93e5.js"><link rel="prefetch" href="/assets/js/84.c9f4cb8f.js"><link rel="prefetch" href="/assets/js/85.95ab5948.js"><link rel="prefetch" href="/assets/js/86.ec0deee5.js"><link rel="prefetch" href="/assets/js/87.5a7655e9.js"><link rel="prefetch" href="/assets/js/88.c913802f.js"><link rel="prefetch" href="/assets/js/89.2854c732.js"><link rel="prefetch" href="/assets/js/9.36a96d9e.js"><link rel="prefetch" href="/assets/js/90.09365798.js"><link rel="prefetch" href="/assets/js/91.72e30caa.js"><link rel="prefetch" href="/assets/js/92.46a94a91.js"><link rel="prefetch" href="/assets/js/93.9a476cea.js"><link rel="prefetch" href="/assets/js/94.94b873fd.js"><link rel="prefetch" href="/assets/js/95.da1f2715.js"><link rel="prefetch" href="/assets/js/96.0cbbd52d.js"><link rel="prefetch" href="/assets/js/97.4861832d.js"><link rel="prefetch" href="/assets/js/98.2ad82200.js"><link rel="prefetch" href="/assets/js/99.1d20b9eb.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.9c5dedbe.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8c3d1e2d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="忙 · 南易" class="logo"> <span class="site-name can-hide">忙 · 南易</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/node/" class="nav-link router-link-active">node</a></div><div class="nav-item"><a href="/offer/" class="nav-link">offer之道</a></div><div class="nav-item"><a href="/interviewQuestions/bytedance.html" class="nav-link">大厂真题</a></div> <a href="https://github.com/zhenquan321" target="_blank" rel="noopener noreferrer" class="repo-link">
    Git
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/node/" class="nav-link router-link-active">node</a></div><div class="nav-item"><a href="/offer/" class="nav-link">offer之道</a></div><div class="nav-item"><a href="/interviewQuestions/bytedance.html" class="nav-link">大厂真题</a></div> <a href="https://github.com/zhenquan321" target="_blank" rel="noopener noreferrer" class="repo-link">
    Git
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>前言</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>node后端通识</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/node/module.html" class="sidebar-link">模块</a></li><li><a href="/node/event-async.html" class="sidebar-link">事件/异步</a></li><li><a href="/node/process.html" class="sidebar-link">进程</a></li><li><a href="/node/io.html" class="active sidebar-link">IO</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node/io.html#buffer" class="sidebar-link">Buffer</a></li><li class="sidebar-sub-header"><a href="/node/io.html#string-decoder" class="sidebar-link">String Decoder</a></li><li class="sidebar-sub-header"><a href="/node/io.html#stream" class="sidebar-link">Stream</a></li><li class="sidebar-sub-header"><a href="/node/io.html#console" class="sidebar-link">Console</a></li><li class="sidebar-sub-header"><a href="/node/io.html#file" class="sidebar-link">File</a></li><li class="sidebar-sub-header"><a href="/node/io.html#readline" class="sidebar-link">Readline</a></li><li class="sidebar-sub-header"><a href="/node/io.html#repl" class="sidebar-link">REPL</a></li></ul></li><li><a href="/node/network.html" class="sidebar-link">Network</a></li><li><a href="/node/error.html" class="sidebar-link">错误处理/调试</a></li><li><a href="/node/test.html" class="sidebar-link">测试</a></li><li><a href="/node/util.html" class="sidebar-link">util</a></li><li><a href="/node/storage.html" class="sidebar-link">存储</a></li><li><a href="/node/security.html" class="sidebar-link">安全</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>koa2制作博客教程</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content default"><h1 id="io">IO</h1> <ul><li><a href="/node/io.html#buffer"><code>[Doc]</code> Buffer</a></li> <li><a href="/node/io.html#string-decoder"><code>[Doc]</code> String Decoder (字符串解码)</a></li> <li><a href="/node/io.html#stream"><code>[Doc]</code> Stream (流)</a></li> <li><a href="/node/io.html#console"><code>[Doc]</code> Console (控制台)</a></li> <li><a href="/node/io.html#file"><code>[Doc]</code> File System (文件系统)</a></li> <li><a href="/node/io.html#readline"><code>[Doc]</code> Readline</a></li> <li><a href="/node/io.html#repl"><code>[Doc]</code> REPL</a></li></ul> <h1 id="简述">简述</h1> <p>Node.js 是以 IO 密集型业务著称. 那么问题来了, 你真的了解什么叫 IO, 什么又叫 IO 密集型业务吗?</p> <h2 id="buffer">Buffer</h2> <p>Buffer 是 Node.js 中用于处理二进制数据的类, 其中与 IO 相关的操作 (网络/文件等) 均基于 Buffer. Buffer 类的实例非常类似整数数组, <em><strong>但其大小是固定不变的</strong></em>, 并且其内存在 V8 堆栈外分配原始内存空间. Buffer 类的实例创建之后, 其所占用的内存大小就不能再进行调整.</p> <p>在 Node.js v6.x 之后 <code>new Buffer()</code> 接口开始被废弃, 理由是参数类型不同会返回不同类型的 Buffer 对象, 所以当开发者没有正确校验参数或没有正确初始化 Buffer 对象的内容时, 以及不了解的情况下初始化  就会在不经意间向代码中引入安全性和可靠性问题.</p> <table><thead><tr><th>接口</th> <th>用途</th></tr></thead> <tbody><tr><td>Buffer.from()</td> <td>根据已有数据生成一个 Buffer 对象</td></tr> <tr><td>Buffer.alloc()</td> <td>创建一个初始化后的 Buffer 对象</td></tr> <tr><td>Buffer.allocUnsafe()</td> <td>创建一个未初始化的 Buffer 对象</td></tr></tbody></table> <h3 id="typedarray">TypedArray</h3> <p>Node.js 的 Buffer 在 ES6 增加了 TypedArray 类型之后, 修改了原来的 Buffer 的实现, 选择基于 TypedArray 中 Uint8Array 来实现, 从而提升了一波性能.</p> <p>使用上, 你需要了解如下情况:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint16Array</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">;</span>
arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4000</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> buf1 <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 拷贝了该 buffer</span>
<span class="token keyword">const</span> buf2 <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>arr<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 与该数组共享了内存</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 输出: &lt;Buffer 88 a0&gt;, 拷贝的 buffer 只有两个元素</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 输出: &lt;Buffer 88 13 a0 0f&gt;</span>

arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">6000</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 输出: &lt;Buffer 88 a0&gt;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buf2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 输出: &lt;Buffer 88 13 70 17&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h2 id="string-decoder">String Decoder</h2> <p>字符串解码器 (String Decoder) 是一个用于将 Buffer 拿来 decode 到 string 的模块, 是作为 Buffer.toString 的一个补充, 它支持多字节 UTF-8 和 UTF-16 字符. 例如</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> StringDecoder <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'string_decoder'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>StringDecoder<span class="token punctuation">;</span>
<span class="token keyword">const</span> decoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringDecoder</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> cent <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0xC2</span><span class="token punctuation">,</span> <span class="token number">0xA2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>decoder<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>cent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ¢</span>

<span class="token keyword">const</span> euro <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0xE2</span><span class="token punctuation">,</span> <span class="token number">0x82</span><span class="token punctuation">,</span> <span class="token number">0xAC</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>decoder<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>euro<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// €</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>stringDecoder.write 会确保返回的字符串不包含 Buffer 末尾残缺的多字节字符，残缺的多字节字符会被保存在一个内部的 buffer 中用于下次调用 stringDecoder.write() 或 stringDecoder.end()。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> StringDecoder <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'string_decoder'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>StringDecoder<span class="token punctuation">;</span>
<span class="token keyword">const</span> decoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringDecoder</span><span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

decoder<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0xE2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
decoder<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0x82</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>decoder<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0xAC</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// €</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="stream">Stream</h2> <p>Node.js 内置的 <code>stream</code> 模块是多个核心模块的基础. 但是流 (stream) 是一种很早之前流行的编程方式. 可以用大家比较熟悉的 C语言来看这种流式操作:</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>
<span class="token keyword">int</span> <span class="token function">copy</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>src<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dest<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    FILE <span class="token operator">*</span>fpSrc<span class="token punctuation">,</span> <span class="token operator">*</span>fpDest<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>BUF_SIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> lenSrc<span class="token punctuation">,</span> lenDest<span class="token punctuation">;</span>

    <span class="token comment">// 打开要 src 的文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fpSrc <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> <span class="token string">&quot;r&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;文件 '%s' 无法打开\n&quot;</span><span class="token punctuation">,</span> src<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> FAILURE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 打开 dest 的文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fpDest <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> <span class="token string">&quot;w&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;文件 '%s' 无法打开\n&quot;</span><span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fclose</span><span class="token punctuation">(</span>fpSrc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> FAILURE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 从 src 中读取 BUF_SIZE 长的数据到 buf 中</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>lenSrc <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> BUF_SIZE<span class="token punctuation">,</span> fpSrc<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// 将 buf 中的数据写入 dest 中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>lenDest <span class="token operator">=</span> <span class="token function">fwrite</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> lenSrc<span class="token punctuation">,</span> fpDest<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> lenSrc<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;写入文件 '%s' 失败\n&quot;</span><span class="token punctuation">,</span> dest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fclose</span><span class="token punctuation">(</span>fpSrc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">fclose</span><span class="token punctuation">(</span>fpDest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> FAILURE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 写入成功后清空 buf</span>
        <span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> BUF_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token comment">// 关闭文件</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>fpSrc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>fpDest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> SUCCESS<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>应用的场景很简单, 你要拷贝一个 20G 大的文件, 如果你一次性将 20G 的数据读入到内存, 你的内存条可能不够用, 或者严重影响性能. 但是你如果使用一个 1MB 大小的缓存 (buf) 每次读取 1Mb, 然后写入 1Mb, 那么不论这个文件多大都只会占用 1Mb 的内存.</p> <p>而在 Node.js 中, 原理与上述 C 代码类似, 不过在读写的实现上通过 libuv 与 EventEmitter 加上了异步的特性. 在 linux/unix 中你可以通过 <code>|</code> 来感受到流式操作.</p> <h3 id="stream-的类型">Stream 的类型</h3> <table><thead><tr><th>类</th> <th>使用场景</th> <th>重写方法</th></tr></thead> <tbody><tr><td><a href="https://github.com/substack/stream-handbook#readable-streams" target="_blank" rel="noopener noreferrer">Readable<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td>只读</td> <td>_read</td></tr> <tr><td><a href="https://github.com/substack/stream-handbook#writable-streams" target="_blank" rel="noopener noreferrer">Writable<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td>只写</td> <td>_write</td></tr> <tr><td><a href="https://github.com/substack/stream-handbook#duplex" target="_blank" rel="noopener noreferrer">Duplex<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td>读写</td> <td>_read, _write</td></tr> <tr><td><a href="https://github.com/substack/stream-handbook#transform" target="_blank" rel="noopener noreferrer">Transform<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></td> <td>操作被写入数据, 然后读出结果</td> <td>_transform, _flush</td></tr></tbody></table> <h3 id="对象模式">对象模式</h3> <p>通过 Node API 创建的流, 只能够对字符串或者 buffer 对象进行操作. 但其实流的实现是可以基于其他的 JavaScript 类型(除了 null, 它在流中有特殊的含义)的. 这样的流就处在 &quot;对象模式(objectMode)&quot; 中.
在创建流对象的时候, 可以通过提供 <code>objectMode</code> 参数来生成对象模式的流. 试图将现有的流转换为对象模式是不安全的.</p> <h3 id="缓冲区">缓冲区</h3> <p>Node.js 中 stream 的缓冲区, 以开头的 C语言 拷贝文件的代码为模板讨论, (抛开异步的区别看) 则是从 <code>src</code> 中读出数据到 <code>buf</code> 中后, 并没有直接写入 <code>dest</code> 中, 而是先放在一个比较大的缓冲区中, 等待写入(消费) <code>dest</code> 中. 即, 在缓冲区的帮助下可以使读与写的过程分离.</p> <p>Readable 和 Writable 流都会将数据储存在内部的缓冲区中. 缓冲区可以分别通过 <code>writable._writableState.getBuffer()</code> 和 <code>readable._readableState.buffer</code> 来访问. 缓冲区的大小, 由构造 stream 时候的 <code>highWaterMark</code> 标志指定可容纳的 byte 大小, 对于 <code>objectMode</code> 的 stream, 该标志表示可以容纳的对象个数.</p> <h4 id="可读流">可读流</h4> <p>当一个可读实例调用 <code>stream.push()</code> 方法的时候, 数据将会被推入缓冲区. 如果数据没有被消费, 即调用 <code>stream.read()</code> 方法读取的话, 那么数据会一直留在缓冲队列中. 当缓冲区中的数据到达 <code>highWaterMark</code> 指定的阈值, 可读流将停止从底层汲取数据, 直到当前缓冲的报备成功消耗为止.</p> <h4 id="可写流">可写流</h4> <p>在一个在可写实例上不停地调用 writable.write(chunk) 的时候数据会被写入可写流的缓冲区. 如果当前缓冲区的缓冲的数据量低于 <code>highWaterMark</code> 设定的值, 调用 writable.write() 方法会返回 true (表示数据已经写入缓冲区), 否则当缓冲的数据量达到了阈值, 数据无法写入缓冲区 write 方法会返回 false, 直到 drain 事件触发之后才能继续调用 write 写入.</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// Write the data to the supplied writable stream one million times.</span>
<span class="token comment">// Be attentive to back-pressure.</span>
<span class="token keyword">function</span> <span class="token function">writeOneMillionTimes</span><span class="token punctuation">(</span>writer<span class="token punctuation">,</span> data<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span>
  <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> ok <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      i<span class="token operator">--</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// last time!</span>
        writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// see if we should continue, or wait</span>
        <span class="token comment">// don't pass the callback, because we're not done yet.</span>
        ok <span class="token operator">=</span> writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> ok<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// had to stop early!</span>
      <span class="token comment">// write some more once it drains</span>
      writer<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'drain'</span><span class="token punctuation">,</span> write<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h4 id="duplex-与-transform">Duplex 与 Transform</h4> <p>Duplex 流和 Transform 流都是同时可读写的, 他们会在内部维持两个缓冲区, 分别对应读取和写入, 这样就可以允许两边同时独立操作, 维持高效的数据流. 比如说 net.Socket 是一个 Duplex 流, Readable 端允许从 socket 获取、消耗数据, Writable 端允许向 socket 写入数据. 数据写入的速度很有可能与消耗的速度有差距, 所以两端可以独立操作和缓冲是很重要的.</p> <h3 id="pipe">pipe</h3> <p>stream 的 <code>.pipe()</code>, 将一个可写流附到可读流上, 同时将可写流切换到流模式, 并把所有数据推给可写流. 在 pipe 传递数据的过程中, <code>objectMode</code> 是传递引用, 非 <code>objectMode</code> 则是拷贝一份数据传递下去.</p> <p>pipe 方法最主要的目的就是将数据的流动缓冲到一个可接受的水平, 不让不同速度的数据源之间的差异导致内存被占满. 关于 pipe 的实现参见 David Cai 的 <a href="https://cnodejs.org/topic/56ba030271204e03637a3870" target="_blank" rel="noopener noreferrer">通过源码解析 Node.js 中导流（pipe）的实现<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="console">Console</h2> <p><a href="https://nodejs.org/dist/latest-v6.x/docs/api/process.html#process_a_note_on_process_i_o" target="_blank" rel="noopener noreferrer">console.log 同步还是异步取决于与谁相连和<code>os</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. 不过一般情况下的实现都是如下 (<a href="https://github.com/nodejs/node/blob/v6.x/lib/console.js#L42" target="_blank" rel="noopener noreferrer">6.x 源代码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)，其中<code>this._stdout</code>默认是<code>process.stdout</code>:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// As of v8 5.0.71.32, the combination of rest param, template string</span>
<span class="token comment">// and .apply(null, args) benchmarks consistently faster than using</span>
<span class="token comment">// the spread operator when calling util.format.</span>
Console<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>util<span class="token punctuation">.</span>format<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>自己实现一个 console.log 可以参考如下代码:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> <span class="token function-variable function">print</span> <span class="token operator">=</span> <span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> process<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>str <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'hello world'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>注意: 该代码并没有处理多参数, 也没有处理占位符 (即 util.format 的功能).</p> <h3 id="console-log-bind-console-问题">console.log.bind(console) 问题</h3> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 源码出处 https://github.com/nodejs/node/blob/v6.x/lib/console.js</span>
<span class="token keyword">function</span> <span class="token function">Console</span><span class="token punctuation">(</span>stdout<span class="token punctuation">,</span> stderr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ... init ...</span>

  <span class="token comment">// bind the prototype functions to this Console instance</span>
  <span class="token keyword">var</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>Console<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> v <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> v <span class="token operator">&lt;</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> v<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> k <span class="token operator">=</span> keys<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="file">File</h2> <p>“一切皆是文件”是 Unix/Linux 的基本哲学之一, 不仅普通的文件、目录、字符设备、块设备、套接字等在 Unix/Linux 中都是以文件被对待, 也就是说这些资源的操作对象均为 fd (文件描述符), 都可以通过同一套 system call 来读写. 在 linux 中你可以通过 ulimit 来对 fd 资源进行一定程度的管理限制.</p> <p>Node.js 封装了标准 POSIX 文件 I/O 操作的集合. 通过 require('fs') 可以加载该模块. 该模块中的所有方法都有异步执行和同步执行两个版本. 你可以通过 fs.open 获得一个文件的文件描述符.</p> <h3 id="编码">编码</h3> <p>// TODO</p> <p>UTF8, GBK, es6 中对编码的支持, 如何计算一个汉字的长度</p> <p>BOM</p> <h3 id="stdio">stdio</h3> <p>stdio (standard input output) 标准的输入输出流, 即输入流 (stdin), 输出流 (stdout), 错误流 (stderr) 三者. 在 Node.js 中分别对应 <code>process.stdin</code> (Readable), <code>process.stdout</code> (Writable) 以及 <code>process.stderr</code> (Writable) 三个 stream.</p> <p>输出函数是每个人在学习任何一门编程语言时所需要学到的第一个函数. 例如 C语言的 <code>printf(&quot;hello, world!&quot;);</code> python/ruby 的 <code>print 'hello, world!'</code> 以及 JavaScript 中的 <code>console.log('hello, world!');</code></p> <p>以 C语言的伪代码来看的话, 这类输出函数的实现思路如下:</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">printf</span><span class="token punctuation">(</span>FILE <span class="token operator">*</span>stream<span class="token punctuation">,</span> 要打印的内容<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token comment">// ...</span>

  <span class="token comment">// 1. 申请一个临时内存空间</span>
  <span class="token keyword">char</span> <span class="token operator">*</span>s <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 2. 处理好要打印的的内容, 其值存储在 s 中</span>
  <span class="token comment">//      ...</span>

  <span class="token comment">// 3. 将 s 上的内容写入到 stream 中</span>
  <span class="token function">fwrite</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 4. 释放临时空间</span>
  <span class="token function">free</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>我们需要了解的是第 3 步, 其中的 stream 则是指 stdout (输出流). 实际上在 shell 上运行一个应用程序的时候, shell 做的第一个操作是 fork 当前 shell 的进程 (所以, 如果你通过 ps 去查看你从 shell 上启动的进程, 其父进程 pid 就是当前 shell 的 pid), 在这个过程中也把 shell 的 stdio 继承给了你当前的应用进程, 所以你在当前进程里面将数据写入到 stdout, 也就是写入到了 shell 的 stdout, 即在当前 shell 上显示了.</p> <p>输入也是同理, 当前进程继承了 shell 的 stdin, 所以当你从 stdin 中读取数据时, 其实就获取到你在 shell 上输入的数据. (PS: shell 可以是 windows 下的 cmd, powershell, 也可以是 linux 下 bash 或者 zsh 等)</p> <p>当你使用 ssh 在远程服务器上运行一个命令的时候, 在服务器上的命令输出虽然也是写入到服务器上 shell 的 stdout, 但是这个远程的 shell 是从 sshd 服务上 fork 出来的, 其 stdout 是继承自 sshd 的一个 fd, 这个 fd 其实是个 socket, 所以最终其实是写入到了一个 socket 中, 通过这个 socket 传输你本地的计算机上的 shell 的 stdout.</p> <p>如果你理解了上述情况, 那么你也就能理解为什么守护进程需要关闭 stdio, 如果切到后台的守护进程没有关闭 stdio 的话, 那么你在用 shell 操作的过程中, 屏幕上会莫名其妙的多出来一些输出. 此处对应<a href="/node/process.html#守护进程">守护进程</a>的 C 实现中的这一段:</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">getdtablesize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token function">close</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 关闭打开的 fd</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Linux/unix 的 fd 都被设计为整型数字, 从 0 开始. 你可以尝试运行如下代码查看.</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>console.log(process.stdin.fd); // 0
console.log(process.stdout.fd); // 1
console.log(process.stderr.fd); // 2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在上一节中的 <a href="/node/process.html#q-child">在 IPC 通道建立之前, 父进程与子进程是怎么通信的? 如果没有通信, 那 IPC 是怎么建立的?</a> 中使用环境变量传递 fd 的方法, 这么看起来就很直白了, 因为传递 fd 其实是直接传递了一个整型数字.</p> <h3 id="如何同步的获取用户的输入">如何同步的获取用户的输入?</h3> <p>如果你理解了上述的内容, 那么放到 Node.js 中来看, 获取用户的输入其实就是读取 Node.js 进程中的输入流 (即 process.stdin 这个 stream) 的数据.</p> <p>而要同步读取, 则是不用异步的 read 接口, 而是用同步的 readSync 接口去读取 stdin 的数据即可实现. 以下来自万能的 stackoverflow:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/*
 * http://stackoverflow.com/questions/3430939/node-js-readsync-from-stdin
 * @mklement0
 */</span>
<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token constant">BUFSIZE</span> <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> buf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span><span class="token constant">BUFSIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> bytesRead<span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> fd <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'win32'</span> <span class="token operator">===</span> process<span class="token punctuation">.</span>platform<span class="token punctuation">)</span> <span class="token operator">?</span> process<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>fd <span class="token punctuation">:</span> fs<span class="token punctuation">.</span><span class="token function">openSync</span><span class="token punctuation">(</span><span class="token string">'/dev/stdin'</span><span class="token punctuation">,</span> <span class="token string">'rs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  bytesRead <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    bytesRead <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readSync</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">BUFSIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token string">'EAGAIN'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 'resource temporarily unavailable'</span>
      <span class="token comment">// Happens on OS X 10.8.3 (not Windows 7!), if there's no</span>
      <span class="token comment">// stdin input - typically when invoking a script without any</span>
      <span class="token comment">// input (for interactive stdin input).</span>
      <span class="token comment">// If you were to just continue, you'd create a tight loop.</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'ERROR: interactive stdin input not supported.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token string">'EOF'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Happens on Windows 7, but not OS X 10.8.3:</span>
      <span class="token comment">// simply signals the end of *piped* stdin input.</span>
      <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">throw</span> e<span class="token punctuation">;</span> <span class="token comment">// unexpected exception</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesRead <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// No more stdin input available.</span>
    <span class="token comment">// OS X 10.8.3: regardless of input method, this is how the end </span>
    <span class="token comment">//   of input is signaled.</span>
    <span class="token comment">// Windows 7: this is how the end of input is signaled for</span>
    <span class="token comment">//   *interactive* stdin input.</span>
    <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Process the chunk read.</span>

  <span class="token keyword">var</span> content <span class="token operator">=</span> buf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bytesRead <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> content<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><h2 id="readline">Readline</h2> <p><code>readline</code> 模块提供了一个用于从 Readble 的 stream (例如 process.stdin) 中一次读取一行的接口. 当然你也可以用来读取文件或者 net, http 的 stream, 比如:</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> readline <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'readline'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> rl <span class="token operator">=</span> readline<span class="token punctuation">.</span><span class="token function">createInterface</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  input<span class="token punctuation">:</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'sample.txt'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

rl<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'line'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>line<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Line from file: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>line<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>实现上, realine 在读取 TTY 的数据时, 是通过 <code>input.on('keypress', onkeypress)</code> 时发现用户按下了回车键来判断是新的 line 的, 而读取一般的 stream 时, 则是通过缓存数据然后用正则 .test 来判断是否为 new line 的.</p> <p>PS: 打个广告, 如果在编写脚本时, 不习惯这样异步获取输入, 想要同步获取同步的用户输入可以看一看这个 Node.js 版本类 C语言使用的 <a href="https://github.com/Lellansin/node-scanf/" target="_blank" rel="noopener noreferrer">scanf<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 模块 (支持 ts).</p> <h2 id="repl">REPL</h2> <p>Read-Eval-Print-Loop (REPL)</p> <p>整理中</p></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/zhenquan321/edit/master/src/node/io.md" target="_blank" rel="noopener noreferrer">Found a bug? Help me improve this page!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/node/process.html" class="prev">
          进程
        </a></span> <span class="next"><a href="/node/network.html">
          Network
        </a>
        →
      </span></p></div> </div> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.239b68c1.js" defer></script><script src="/assets/js/4.d46d2a2b.js" defer></script><script src="/assets/js/55.8c60f9b3.js" defer></script>
  </body>
</html>
