<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Event Loop详解 | 忙 · 南易</title>
    <meta name="description" content="">
    <link rel="apple-touch-icon" sizes="128x128" href="/favicon_128.ico">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/assets/css/0.styles.8c3d1e2d.css" as="style"><link rel="preload" href="/assets/js/app.239b68c1.js" as="script"><link rel="preload" href="/assets/js/4.d46d2a2b.js" as="script"><link rel="preload" href="/assets/js/98.2ad82200.js" as="script"><link rel="prefetch" href="/assets/js/10.b85db015.js"><link rel="prefetch" href="/assets/js/100.090b8e5b.js"><link rel="prefetch" href="/assets/js/101.bbb676d9.js"><link rel="prefetch" href="/assets/js/102.31f82669.js"><link rel="prefetch" href="/assets/js/103.3fb1b48a.js"><link rel="prefetch" href="/assets/js/104.80be1959.js"><link rel="prefetch" href="/assets/js/105.89cad783.js"><link rel="prefetch" href="/assets/js/106.cb6bd33d.js"><link rel="prefetch" href="/assets/js/107.c7d98004.js"><link rel="prefetch" href="/assets/js/108.9ca655c2.js"><link rel="prefetch" href="/assets/js/109.5e2ba8b1.js"><link rel="prefetch" href="/assets/js/11.8a5621e5.js"><link rel="prefetch" href="/assets/js/110.b867730c.js"><link rel="prefetch" href="/assets/js/111.242ec554.js"><link rel="prefetch" href="/assets/js/112.bbd310d2.js"><link rel="prefetch" href="/assets/js/113.2ba206f8.js"><link rel="prefetch" href="/assets/js/114.644edd11.js"><link rel="prefetch" href="/assets/js/115.a339d164.js"><link rel="prefetch" href="/assets/js/116.cf7458b9.js"><link rel="prefetch" href="/assets/js/117.e2e9ca56.js"><link rel="prefetch" href="/assets/js/118.7e01e661.js"><link rel="prefetch" href="/assets/js/119.7073a3db.js"><link rel="prefetch" href="/assets/js/12.8ca07f51.js"><link rel="prefetch" href="/assets/js/120.9c083d37.js"><link rel="prefetch" href="/assets/js/121.ac7f0ca1.js"><link rel="prefetch" href="/assets/js/122.64c5b517.js"><link rel="prefetch" href="/assets/js/123.8a0a80cb.js"><link rel="prefetch" href="/assets/js/124.b76549a6.js"><link rel="prefetch" href="/assets/js/125.02891ed0.js"><link rel="prefetch" href="/assets/js/126.a80fde29.js"><link rel="prefetch" href="/assets/js/127.9672de41.js"><link rel="prefetch" href="/assets/js/128.a8f89366.js"><link rel="prefetch" href="/assets/js/129.b3a2be2c.js"><link rel="prefetch" href="/assets/js/13.4f05305e.js"><link rel="prefetch" href="/assets/js/130.f5bbfe20.js"><link rel="prefetch" href="/assets/js/131.619a21f8.js"><link rel="prefetch" href="/assets/js/132.b01b8b37.js"><link rel="prefetch" href="/assets/js/133.4382d00b.js"><link rel="prefetch" href="/assets/js/14.5db8683e.js"><link rel="prefetch" href="/assets/js/15.6b87427e.js"><link rel="prefetch" href="/assets/js/16.e1fdb4cb.js"><link rel="prefetch" href="/assets/js/17.e8dfb0d0.js"><link rel="prefetch" href="/assets/js/18.9b867385.js"><link rel="prefetch" href="/assets/js/19.d3b46571.js"><link rel="prefetch" href="/assets/js/20.0bd7a691.js"><link rel="prefetch" href="/assets/js/21.f2ee9685.js"><link rel="prefetch" href="/assets/js/22.16c26579.js"><link rel="prefetch" href="/assets/js/23.f0774a27.js"><link rel="prefetch" href="/assets/js/24.290660c4.js"><link rel="prefetch" href="/assets/js/25.706f054c.js"><link rel="prefetch" href="/assets/js/26.6cfc93c6.js"><link rel="prefetch" href="/assets/js/27.6a7f220d.js"><link rel="prefetch" href="/assets/js/28.bd142947.js"><link rel="prefetch" href="/assets/js/29.a2b14612.js"><link rel="prefetch" href="/assets/js/3.818110a1.js"><link rel="prefetch" href="/assets/js/30.9f7add30.js"><link rel="prefetch" href="/assets/js/31.fc0eadbc.js"><link rel="prefetch" href="/assets/js/32.0972df93.js"><link rel="prefetch" href="/assets/js/33.78a10b29.js"><link rel="prefetch" href="/assets/js/34.f80e138d.js"><link rel="prefetch" href="/assets/js/35.f52d3dc4.js"><link rel="prefetch" href="/assets/js/36.e223d306.js"><link rel="prefetch" href="/assets/js/37.aeeb8e54.js"><link rel="prefetch" href="/assets/js/38.f65fd618.js"><link rel="prefetch" href="/assets/js/39.7e851236.js"><link rel="prefetch" href="/assets/js/40.d019d91b.js"><link rel="prefetch" href="/assets/js/41.c962b044.js"><link rel="prefetch" href="/assets/js/42.8cd2d4d1.js"><link rel="prefetch" href="/assets/js/43.d1549175.js"><link rel="prefetch" href="/assets/js/44.b108b4ff.js"><link rel="prefetch" href="/assets/js/45.3390da9f.js"><link rel="prefetch" href="/assets/js/46.b1a33f56.js"><link rel="prefetch" href="/assets/js/47.d9b28254.js"><link rel="prefetch" href="/assets/js/48.982bd1ea.js"><link rel="prefetch" href="/assets/js/49.3f86d8d4.js"><link rel="prefetch" href="/assets/js/5.93da9e01.js"><link rel="prefetch" href="/assets/js/50.2b473707.js"><link rel="prefetch" href="/assets/js/51.37a14f99.js"><link rel="prefetch" href="/assets/js/52.a9a5bf81.js"><link rel="prefetch" href="/assets/js/53.5df34f20.js"><link rel="prefetch" href="/assets/js/54.eee1fc68.js"><link rel="prefetch" href="/assets/js/55.8c60f9b3.js"><link rel="prefetch" href="/assets/js/56.4427e1a8.js"><link rel="prefetch" href="/assets/js/57.9a90a4bc.js"><link rel="prefetch" href="/assets/js/58.5989177f.js"><link rel="prefetch" href="/assets/js/59.5b9bee7d.js"><link rel="prefetch" href="/assets/js/6.ee63d877.js"><link rel="prefetch" href="/assets/js/60.9d11c5de.js"><link rel="prefetch" href="/assets/js/61.f8a874b8.js"><link rel="prefetch" href="/assets/js/62.5ae74cbf.js"><link rel="prefetch" href="/assets/js/63.860cbb55.js"><link rel="prefetch" href="/assets/js/64.91d218ca.js"><link rel="prefetch" href="/assets/js/65.cf09d12a.js"><link rel="prefetch" href="/assets/js/66.3e9ee600.js"><link rel="prefetch" href="/assets/js/67.efa5e577.js"><link rel="prefetch" href="/assets/js/68.c2dfb597.js"><link rel="prefetch" href="/assets/js/69.9ee476ed.js"><link rel="prefetch" href="/assets/js/7.9b9102dd.js"><link rel="prefetch" href="/assets/js/70.8d130c77.js"><link rel="prefetch" href="/assets/js/71.a10dbf8e.js"><link rel="prefetch" href="/assets/js/72.ae7c169f.js"><link rel="prefetch" href="/assets/js/73.d9a699cd.js"><link rel="prefetch" href="/assets/js/74.a1b1fcc0.js"><link rel="prefetch" href="/assets/js/75.cac138d8.js"><link rel="prefetch" href="/assets/js/76.41fe939b.js"><link rel="prefetch" href="/assets/js/77.d0a38d4e.js"><link rel="prefetch" href="/assets/js/78.75712491.js"><link rel="prefetch" href="/assets/js/79.21229e83.js"><link rel="prefetch" href="/assets/js/8.d1ef3d0e.js"><link rel="prefetch" href="/assets/js/80.e54b6c68.js"><link rel="prefetch" href="/assets/js/81.07a2f128.js"><link rel="prefetch" href="/assets/js/82.85dcf320.js"><link rel="prefetch" href="/assets/js/83.e66d93e5.js"><link rel="prefetch" href="/assets/js/84.c9f4cb8f.js"><link rel="prefetch" href="/assets/js/85.95ab5948.js"><link rel="prefetch" href="/assets/js/86.ec0deee5.js"><link rel="prefetch" href="/assets/js/87.5a7655e9.js"><link rel="prefetch" href="/assets/js/88.c913802f.js"><link rel="prefetch" href="/assets/js/89.2854c732.js"><link rel="prefetch" href="/assets/js/9.36a96d9e.js"><link rel="prefetch" href="/assets/js/90.09365798.js"><link rel="prefetch" href="/assets/js/91.72e30caa.js"><link rel="prefetch" href="/assets/js/92.46a94a91.js"><link rel="prefetch" href="/assets/js/93.9a476cea.js"><link rel="prefetch" href="/assets/js/94.94b873fd.js"><link rel="prefetch" href="/assets/js/95.da1f2715.js"><link rel="prefetch" href="/assets/js/96.0cbbd52d.js"><link rel="prefetch" href="/assets/js/97.4861832d.js"><link rel="prefetch" href="/assets/js/99.1d20b9eb.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.9c5dedbe.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8c3d1e2d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="忙 · 南易" class="logo"> <span class="site-name can-hide">忙 · 南易</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/node/" class="nav-link">node</a></div><div class="nav-item"><a href="/offer/" class="nav-link router-link-active">offer之道</a></div><div class="nav-item"><a href="/interviewQuestions/bytedance.html" class="nav-link">大厂真题</a></div> <a href="https://github.com/zhenquan321" target="_blank" rel="noopener noreferrer" class="repo-link">
    Git
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/node/" class="nav-link">node</a></div><div class="nav-item"><a href="/offer/" class="nav-link router-link-active">offer之道</a></div><div class="nav-item"><a href="/interviewQuestions/bytedance.html" class="nav-link">大厂真题</a></div> <a href="https://github.com/zhenquan321" target="_blank" rel="noopener noreferrer" class="repo-link">
    Git
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>前言</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/offer/" class="sidebar-link">声明·感谢：</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>面试技巧</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>推荐</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>前端基础</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>前端基础笔试</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>前端原理详解</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/offer/hoisting.html" class="sidebar-link">JavaScript的『预解释』与『变量提升』</a></li><li><a href="/offer/eventLoop.html" class="active sidebar-link">Event Loop详解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/offer/eventLoop.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/offer/eventLoop.html#为啥要弄懂event-loop" class="sidebar-link">为啥要弄懂Event Loop</a></li><li class="sidebar-sub-header"><a href="/offer/eventLoop.html#栈、队列的基本概念" class="sidebar-link">栈、队列的基本概念</a></li><li class="sidebar-sub-header"><a href="/offer/eventLoop.html#event-loop" class="sidebar-link">Event Loop</a></li><li class="sidebar-sub-header"><a href="/offer/eventLoop.html#浏览器中的event-loop" class="sidebar-link">浏览器中的Event Loop</a></li><li class="sidebar-sub-header"><a href="/offer/eventLoop.html#举个例子" class="sidebar-link">举个例子</a></li><li class="sidebar-sub-header"><a href="/offer/eventLoop.html#再举个例子" class="sidebar-link">再举个例子</a></li><li class="sidebar-sub-header"><a href="/offer/eventLoop.html#nodejs的event-loop" class="sidebar-link">NodeJS的Event Loop</a></li><li class="sidebar-sub-header"><a href="/offer/eventLoop.html#setimmediate-的settimeout-的区别" class="sidebar-link">setImmediate() 的setTimeout()的区别</a></li><li class="sidebar-sub-header"><a href="/offer/eventLoop.html#process-nexttick" class="sidebar-link">Process.nextTick()</a></li></ul></li><li><a href="/offer/immutable.html" class="sidebar-link">实现不可变数据</a></li><li><a href="/offer/memory.html" class="sidebar-link">JavaScript内存管理</a></li><li><a href="/offer/deepclone.html" class="sidebar-link">实现深克隆</a></li><li><a href="/offer/event.html" class="sidebar-link">如何实现一个Event</a></li><li><a href="/offer/mechanism.html" class="sidebar-link">JavaScript的运行机制</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>计算机基础</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>数据结构与算法</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>前端框架</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>框架原理详解</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>框架实战技巧</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>工程化</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>工程化原理</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>安全</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content default"><h1 id="event-loop详解">Event Loop详解</h1> <blockquote><p>本文是<a href="https://juejin.im/post/5c3d8956e51d4511dc72c200?utm_source=gold_browser_extension#comment" target="_blank" rel="noopener noreferrer">弄懂Event Loop<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的删改版，去除了原文中一些容易引起歧义的部分，对一些内容进行了扩充</p></blockquote> <h2 id="前言">前言</h2> <p><code>Event Loop</code>即事件循环，是指浏览器或<code>Node</code>的一种解决<code>javaScript</code>单线程运行时不会阻塞的一种机制，也就是我们经常使用<strong>异步</strong>的原理。
<a name="Kec8C"></a></p> <h2 id="为啥要弄懂event-loop">为啥要弄懂Event Loop</h2> <ul><li>是要增加自己技术的深度，也就是懂得<code>JavaScript</code>的运行机制。<br></li> <li>现在在前端领域各种技术层出不穷，掌握底层原理，可以让自己以不变，应万变。<br></li> <li>应对各大互联网公司的面试，懂其原理，题目任其发挥。<br> <a name="52BT4"></a></li></ul> <h2 id="栈、队列的基本概念">栈、队列的基本概念</h2> <p><img src="https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995437042-9d683636-9bf5-45fb-8cf3-e482b94a707d.webp#align=left&amp;display=inline&amp;height=271&amp;originHeight=271&amp;originWidth=294&amp;size=0&amp;status=done&amp;width=294" alt=""></p> <h3 id="栈（stack）">栈（Stack）</h3> <p><strong>栈</strong>在计算机科学中是限定仅在<strong>表尾</strong>进行<strong>插入</strong>或<strong>删除</strong>操作的线性表。 <strong>栈</strong>是一种数据结构，它按照<strong>后进先出</strong>的原则存储数据，<strong>先进入</strong>的数据被压入<strong>栈底</strong>，<strong>最后的数据</strong>在<strong>栈顶</strong>，需要读数据的时候从<strong>栈顶</strong>开始<strong>弹出数据</strong>。<br><strong>栈</strong>是只能在<strong>某一端插入</strong>和<strong>删除</strong>的<strong>特殊线性表</strong>。<br><img src="https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995436902-6dcf8420-be5b-4dd9-9fb6-43e567e53c86.webp#align=left&amp;display=inline&amp;height=282&amp;originHeight=282&amp;originWidth=616&amp;size=0&amp;status=done&amp;width=616" alt=""> <a name="Dao1u"></a></p> <h3 id="队列（queue）">队列（Queue）</h3> <p>特殊之处在于它只允许在表的前端（<code>front</code>）进行<strong>删除</strong>操作，而在表的后端（<code>rear</code>）进行<strong>插入</strong>操作，和<strong>栈</strong>一样，<strong>队列</strong>是一种操作受限制的线性表。<br>进行<strong>插入</strong>操作的端称为<strong>队尾</strong>，进行<strong>删除</strong>操作的端称为<strong>队头</strong>。 队列中没有元素时，称为<strong>空队列</strong>。<br><strong>队列</strong>的数据元素又称为<strong>队列元素</strong>。在队列中插入一个队列元素称为<strong>入队</strong>，从<strong>队列</strong>中<strong>删除</strong>一个队列元素称为<strong>出队</strong>。因为队列<strong>只允许</strong>在一端<strong>插入</strong>，在另一端<strong>删除</strong>，所以只有<strong>最早</strong>进入<strong>队列</strong>的元素<strong>才能最先从队列中</strong>删除，故队列又称为<strong>先进先出</strong>（<code>FIFO—first in first out</code>）<br><img src="https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995436932-57cb6ee5-763a-47b2-a0be-4174c4fd1c66.webp#align=left&amp;display=inline&amp;height=270&amp;originHeight=270&amp;originWidth=554&amp;size=0&amp;status=done&amp;width=554" alt=""> <a name="DE6Ak"></a></p> <h2 id="event-loop">Event Loop</h2> <p>在<code>JavaScript</code>中，任务被分为两种，一种宏任务（<code>MacroTask</code>）也叫<code>Task</code>，一种叫微任务（<code>MicroTask</code>）。
<a name="JQeJU"></a></p> <h3 id="macrotask（宏任务）">MacroTask（宏任务）</h3> <ul><li><code>script</code>全部代码、<code>setTimeout</code>、<code>setInterval</code>、<code>setImmediate</code>（浏览器暂时不支持，只有IE10支持，具体可见<a href="https://link.juejin.im/?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FWindow%2FsetImmediate" target="_blank" rel="noopener noreferrer"><code>MDN</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）、<code>I/O</code>、<code>UI Rendering</code>。
<a name="zG8N7"></a></li></ul> <h3 id="microtask（微任务）">MicroTask（微任务）</h3> <ul><li><code>Process.nextTick（Node独有）</code>、<code>Promise</code>、<code>Object.observe(废弃)</code>、<code>MutationObserver</code>（具体使用方式查看<a href="https://link.juejin.im/?target=http%3A%2F%2Fjavascript.ruanyifeng.com%2Fdom%2Fmutationobserver.html" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）
<a name="EvaCF"></a></li></ul> <h2 id="浏览器中的event-loop">浏览器中的Event Loop</h2> <p><code>Javascript</code> 有一个 <code>main thread</code> 主线程和 <code>call-stack</code> 调用栈(执行栈)，所有的任务都会被放到调用栈等待主线程执行。
<a name="GyyZL"></a></p> <h3 id="js调用栈">JS调用栈</h3> <p>JS调用栈采用的是后进先出的规则，当函数执行的时候，会被添加到栈的顶部，当执行栈执行完成后，就会从栈顶移出，直到栈内被清空。
<a name="Hv5X9"></a></p> <h3 id="同步任务和异步任务">同步任务和异步任务</h3> <p><code>Javascript</code>单线程任务被分为<strong>同步任务</strong>和<strong>异步任务</strong>，同步任务会在调用栈中按照顺序等待主线程依次执行，异步任务会在异步任务有了结果后，将注册的回调函数放入任务队列中等待主线程空闲的时候（调用栈被清空），被读取到栈内等待主线程的执行。<br><img src="https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995436925-9ac8fb38-4dfd-4d12-b5fe-c564ede43f80.webp#align=left&amp;display=inline&amp;height=518&amp;originHeight=518&amp;originWidth=636&amp;size=0&amp;status=done&amp;width=636" alt="">任务队列<code>Task Queue</code>，即队列，是一种先进先出的一种数据结构。<img src="https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995437021-43545b5b-0a48-475a-a8a6-cce80433fe1a.webp#align=left&amp;display=inline&amp;height=669&amp;originHeight=669&amp;originWidth=800&amp;size=0&amp;status=done&amp;width=800" alt=""> <a name="gn45S"></a></p> <h3 id="事件循环的进程模型">事件循环的进程模型</h3> <ul><li>选择当前要执行的任务队列，选择任务队列中最先进入的任务，如果任务队列为空即<code>null</code>，则执行跳转到微任务（<code>MicroTask</code>）的执行步骤。</li> <li>将事件循环中的任务设置为已选择任务。</li> <li>执行任务。</li> <li>将事件循环中当前运行任务设置为null。</li> <li>将已经运行完成的任务从任务队列中删除。</li> <li>microtasks步骤：进入microtask检查点。</li> <li>更新界面渲染。</li> <li>返回第一步。
<a name="axvjy"></a></li></ul> <h3 id="执行进入microtask检查点时，用户代理会执行以下步骤：">执行进入microtask检查点时，用户代理会执行以下步骤：</h3> <ul><li>设置microtask检查点标志为true。</li> <li>当事件循环<code>microtask</code>执行不为空时：选择一个最先进入的<code>microtask</code>队列的<code>microtask</code>，将事件循环的<code>microtask</code>设置为已选择的<code>microtask</code>，运行<code>microtask</code>，将已经执行完成的<code>microtask</code>为<code>null</code>，移出<code>microtask</code>中的<code>microtask</code>。</li> <li>清理IndexDB事务</li> <li>设置进入microtask检查点的标志为false。</li></ul> <p>上述可能不太好理解，下图是我做的一张图片。<br><img src="https://cdn.nlark.com/yuque/0/2019/gif/128853/1560995436931-71f56a41-54d3-49f3-a382-c1e6acbf301e.gif#align=left&amp;display=inline&amp;height=589&amp;originHeight=589&amp;originWidth=1011&amp;size=0&amp;status=done&amp;width=1011" alt=""><br>执行栈在执行完<strong>同步任务</strong>后，查看<strong>执行栈</strong>是否为空，如果执行栈为空，就会去检查<strong>微任务</strong>(<code>microTask</code>)队列是否为空，如果为空的话，就执行<code>Task</code>（宏任务），否则就一次性执行完所有微任务。<br>每次单个<strong>宏任务</strong>执行完毕后，检查<strong>微任务</strong>(<code>microTask</code>)队列是否为空，如果不为空的话，会按照<strong>先入先</strong>出的规则全部执行完<strong>微任务</strong>(<code>microTask</code>)后，设置<strong>微任务</strong>(<code>microTask</code>)队列为<code>null</code>，然后再执行<strong>宏任务</strong>，如此循环。
<a name="rd9zs"></a></p> <h2 id="举个例子">举个例子</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script end'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>首先我们划分几个分类：
<a name="Phe8h"></a></p> <h3 id="第一次执行：">第一次执行：</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Tasks：run script、 setTimeout callback
Microtasks：Promise then	
<span class="token constant">JS</span> stack<span class="token punctuation">:</span> script	
Log<span class="token punctuation">:</span> script start、script end。

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>执行同步代码，将宏任务（<code>Tasks</code>）和微任务(<code>Microtasks</code>)划分到各自队列中。
<a name="GZaz9"></a></p> <h3 id="第二次执行：">第二次执行：</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>Tasks：run script、 setTimeout callback
Microtasks：Promise2 then	
JS stack: Promise2 callback	
Log: script start、script end、promise1、promise2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>执行宏任务后，检测到微任务(<code>Microtasks</code>)队列中不为空，执行<code>Promise1</code>，执行完成<code>Promise1</code>后，调用<code>Promise2.then</code>，放入微任务(<code>Microtasks</code>)队列中，再执行<code>Promise2.then</code>。
<a name="6OrDB"></a></p> <h3 id="第三次执行：">第三次执行：</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>Tasks：setTimeout callback
Microtasks：	
JS stack: setTimeout callback
Log: script start、script end、promise1、promise2、setTimeout

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>当微任务(<code>Microtasks</code>)队列中为空时，执行宏任务（<code>Tasks</code>），执行<code>setTimeout callback</code>，打印日志。
<a name="h3YfH"></a></p> <h3 id="第四次执行：">第四次执行：</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>Tasks：setTimeout callback
Microtasks：	
JS stack: 
Log: script start、script end、promise1、promise2、setTimeout

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>清空<strong>Tasks</strong>队列和<code>JS stack</code>。<br>以上执行帧动画可以查看<a href="https://link.juejin.im/?target=https%3A%2F%2Fjakearchibald.com%2F2015%2Ftasks-microtasks-queues-and-schedules%2F" target="_blank" rel="noopener noreferrer">Tasks, microtasks, queues and schedules<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br>或许这张图也更好理解些。<br><img src="https://cdn.nlark.com/yuque/0/2019/gif/128853/1560995436968-c6ff2732-4b20-49d4-852f-8c298eeb0d2e.gif#align=left&amp;display=inline&amp;height=341&amp;originHeight=341&amp;originWidth=611&amp;size=0&amp;status=done&amp;width=611" alt=""> <a name="SmhP7"></a></p> <h2 id="再举个例子">再举个例子</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script start'</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async1 end'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">async2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'async2 end'</span><span class="token punctuation">)</span> 
<span class="token punctuation">}</span>
<span class="token function">async1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Promise'</span><span class="token punctuation">)</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise2'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'script end'</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>这里需要先理解<code>async/await</code>。<br><code>async/await</code> 在底层转换成了 <code>promise</code> 和 <code>then</code> 回调函数。<br>也就是说，这是 <code>promise</code> 的语法糖。<br>每次我们使用 <code>await</code>, 解释器都创建一个 <code>promise</code> 对象，然后把剩下的 <code>async</code> 函数中的操作放到 <code>then</code> 回调函数中。<br><code>async/await</code> 的实现，离不开 <code>Promise</code>。从字面意思来理解，<code>async</code> 是“异步”的简写，而 <code>await</code> 是 <code>async wait</code> 的简写可以认为是等待异步方法执行完成。
<a name="LRx9h"></a></p> <h3 id="关于73以下版本和73版本的区别"><strong>关于73以下版本和73版本的区别</strong></h3> <ul><li>在老版本版本以下，先执行<code>promise1</code>和<code>promise2</code>，再执行<code>async1</code>。</li> <li>在73版本，先执行<code>async1</code>再执行<code>promise1</code>和<code>promise2</code>。</li></ul> <p><strong>主要原因是因为在谷歌(金丝雀)73版本中更改了规范，如下图所示：</strong><br><img src="https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995436973-49daab42-3959-4cb2-9417-30a651fedf80.webp#align=left&amp;display=inline&amp;height=243&amp;originHeight=243&amp;originWidth=668&amp;size=0&amp;status=done&amp;width=668" alt=""></p> <ul><li>区别在于<code>RESOLVE(thenable)</code>和之间的区别<code>Promise.resolve(thenable)</code>。
<a name="lE9S0"></a></li></ul> <h3 id="在老版本中"><strong>在老版本中</strong></h3> <ul><li>首先，传递给 <code>await</code> 的值被包裹在一个 <code>Promise</code> 中。然后，处理程序附加到这个包装的 <code>Promise</code>，以便在 <code>Promise</code> 变为 <code>fulfilled</code> 后恢复该函数，并且暂停执行异步函数，一旦 <code>promise</code> 变为 <code>fulfilled</code>，恢复异步函数的执行。</li> <li>每个 <code>await</code> 引擎必须创建两个额外的 Promise（即使右侧已经是一个 <code>Promise</code>）并且它需要至少三个 <code>microtask</code> 队列 <code>ticks</code>（<code>tick</code>为系统的相对时间单位，也被称为系统的时基，来源于定时器的周期性中断（输出脉冲），一次中断表示一个<code>tick</code>，也被称做一个“时钟滴答”、时标。）。
<a name="1I6ks"></a></li></ul> <h3 id="引用贺老师知乎上的一个例子"><strong>引用贺老师知乎上的一个例子</strong></h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> p
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>简化理解为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token constant">RESOLVE</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li>如果 <code>RESOLVE(p)</code> 对于 <code>p</code> 为 <code>promise</code> 直接返回 <code>p</code> 的话，那么 <code>p</code>的 <code>then</code> 方法就会被马上调用，其回调就立即进入 <code>job</code> 队列。</li> <li>而如果 <code>RESOLVE(p)</code> 严格按照标准，应该是产生一个新的 <code>promise</code>，尽管该 <code>promise</code>确定会 <code>resolve</code> 为 <code>p</code>，但这个过程本身是异步的，也就是现在进入 <code>job</code> 队列的是新 <code>promise</code>的 <code>resolve</code>过程，所以该 <code>promise</code> 的 <code>then</code> 不会被立即调用，而要等到当前 <code>job</code> 队列执行到前述 <code>resolve</code> 过程才会被调用，然后其回调（也就是继续 <code>await</code> 之后的语句）才加入 <code>job</code> 队列，所以时序上就晚了。
<a name="XRpkE"></a></li></ul> <h3 id="谷歌（金丝雀）73版本中"><strong>谷歌（金丝雀）73版本中</strong></h3> <ul><li>使用对<code>PromiseResolve</code>的调用来更改<code>await</code>的语义，以减少在公共<code>awaitPromise</code>情况下的转换次数。</li> <li>如果传递给 <code>await</code> 的值已经是一个 <code>Promise</code>，那么这种优化避免了再次创建 <code>Promise</code> 包装器，在这种情况下，我们从最少三个 <code>microtick</code> 到只有一个 <code>microtick</code>。
<a name="kbGWS"></a></li></ul> <h3 id="详细过程："><strong>详细过程：</strong></h3> <p><strong>73以下版本</strong></p> <ul><li>首先，打印<code>script start</code>，调用<code>async1()</code>时，返回一个<code>Promise</code>，所以打印出来<code>async2 end</code>。</li> <li>每个 <code>await</code>，会新产生一个<code>promise</code>,但这个过程本身是异步的，所以该<code>await</code>后面不会立即调用。</li> <li>继续执行同步代码，打印<code>Promise</code>和<code>script end</code>，将<code>then</code>函数放入<strong>微任务</strong>队列中等待执行。</li> <li>同步执行完成之后，检查<strong>微任务</strong>队列是否为<code>null</code>，然后按照先入先出规则，依次执行。</li> <li>然后先执行打印<code>promise1</code>,此时<code>then</code>的回调函数返回<code>undefinde</code>，此时又有<code>then</code>的链式调用，又放入<strong>微任务</strong>队列中，再次打印<code>promise2</code>。</li> <li>再回到<code>await</code>的位置执行返回的 <code>Promise</code> 的 <code>resolve</code> 函数，这又会把 <code>resolve</code> 丢到微任务队列中，打印<code>async1 end</code>。</li> <li>当<strong>微任务</strong>队列为空时，执行宏任务,打印<code>setTimeout</code>。</li></ul> <p><strong>谷歌（金丝雀73版本）</strong></p> <ul><li>如果传递给 <code>await</code> 的值已经是一个 <code>Promise</code>，那么这种优化避免了再次创建 <code>Promise</code> 包装器，在这种情况下，我们从最少三个 <code>microtick</code> 到只有一个 <code>microtick</code>。</li> <li>引擎不再需要为 <code>await</code> 创造 <code>throwaway Promise</code> - 在绝大部分时间。</li> <li>现在 <code>promise</code> 指向了同一个 <code>Promise</code>，所以这个步骤什么也不需要做。然后引擎继续像以前一样，创建 <code>throwaway Promise</code>，安排 <code>PromiseReactionJob</code> 在 <code>microtask</code> 队列的下一个 <code>tick</code> 上恢复异步函数，暂停执行该函数，然后返回给调用者。</li></ul> <p>具体详情查看（<a href="https://link.juejin.im/?target=https%3A%2F%2Fv8.js.cn%2Fblog%2Ffast-async%2F" target="_blank" rel="noopener noreferrer">这里<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）。
<a name="lXMku"></a></p> <h2 id="nodejs的event-loop">NodeJS的Event Loop</h2> <p><img src="https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995436966-ae34b24c-83d0-4472-8854-1552abd9fcdb.webp#align=left&amp;display=inline&amp;height=223&amp;originHeight=223&amp;originWidth=543&amp;size=0&amp;status=done&amp;width=543" alt=""><br><code>Node</code>中的<code>Event Loop</code>是基于<code>libuv</code>实现的，而<code>libuv</code>是 <code>Node</code> 的新跨平台抽象层，libuv使用异步，事件驱动的编程方式，核心是提供<code>i/o</code>的事件循环和异步回调。libuv的<code>API</code>包含有时间，非阻塞的网络，异步文件操作，子进程等等。 <code>Event Loop</code>就是在<code>libuv</code>中实现的。<br><img src="https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995436946-e5bcfbd1-340e-4c68-a14e-cd000081eef4.webp#align=left&amp;display=inline&amp;height=442&amp;originHeight=442&amp;originWidth=745&amp;size=0&amp;status=done&amp;width=745" alt=""> <a name="4clmy"></a></p> <h3 id="node的event-loop一共分为6个阶段，每个细节具体如下："><code>Node</code>的<code>Event loop</code>一共分为6个阶段，每个细节具体如下：</h3> <ul><li><code>timers</code>: 执行<code>setTimeout</code>和<code>setInterval</code>中到期的<code>callback</code>。</li> <li><code>pending callback</code>: 上一轮循环中少数的<code>callback</code>会放在这一阶段执行。</li> <li><code>idle, prepare</code>: 仅在内部使用。</li> <li><code>poll</code>: 最重要的阶段，执行<code>pending callback</code>，在适当的情况下回阻塞在这个阶段。</li> <li><code>check</code>: 执行<code>setImmediate</code>(<code>setImmediate()</code>是将事件插入到事件队列尾部，主线程和事件队列的函数执行完成之后立即执行<code>setImmediate</code>指定的回调函数)的<code>callback</code>。</li> <li><code>close callbacks</code>: 执行<code>close</code>事件的<code>callback</code>，例如<code>socket.on('close'[,fn])</code>或者<code>http.server.on('close, fn)</code>。</li></ul> <p>具体细节如下：
<a name="qYgPm"></a></p> <h3 id="timers">timers</h3> <p>执行<code>setTimeout</code>和<code>setInterval</code>中到期的<code>callback</code>，执行这两者回调需要设置一个毫秒数，理论上来说，应该是时间一到就立即执行callback回调，但是由于<code>system</code>的调度可能会延时，达不到预期时间。<br>以下是官网文档解释的例子：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">someAsyncOperation</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Assume this takes 95ms to complete</span>
  fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'/path/to/file'</span><span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> timeoutScheduled <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> delay <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> timeoutScheduled<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>delay<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms have passed since I was scheduled`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// do someAsyncOperation which takes 95 ms to complete</span>
<span class="token function">someAsyncOperation</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> startCallback <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// do something that will take 10ms...</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startCallback <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// do nothing</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>当进入事件循环时，它有一个空队列（<code>fs.readFile()</code>尚未完成），因此定时器将等待剩余毫秒数，当到达95ms时，<code>fs.readFile()</code>完成读取文件并且其完成需要10毫秒的回调被添加到轮询队列并执行。<br>当回调结束时，队列中不再有回调，因此事件循环将看到已达到最快定时器的<strong>阈值</strong>，然后回到<strong>timers阶段</strong>以执行定时器的回调。<br>在此示例中，您将看到正在调度的计时器与正在执行的回调之间的总延迟将为105毫秒。<br><strong>以下是我测试时间：</strong><br><img src="https://cdn.nlark.com/yuque/0/2019/webp/128853/1560995436982-2f817b92-3c4a-4d4c-8f95-92f63efa336c.webp#align=left&amp;display=inline&amp;height=430&amp;originHeight=430&amp;originWidth=724&amp;size=0&amp;status=done&amp;width=724" alt=""> <a name="sLxqs"></a></p> <h3 id="pending-callbacks">pending callbacks</h3> <p>此阶段执行某些系统操作（例如TCP错误类型）的回调。 例如，如果<code>TCP socket ECONNREFUSED</code>在尝试connect时receives，则某些* nix系统希望等待报告错误。 这将在<code>pending callbacks</code>阶段执行。
<a name="3rwhp"></a></p> <h3 id="poll">poll</h3> <p><strong>该poll阶段有两个主要功能：</strong></p> <ul><li>执行<code>I/O</code>回调。</li> <li>处理轮询队列中的事件。</li></ul> <p><strong>当事件循环进入<code>poll</code>阶段并且在<code>timers</code>中没有可以执行定时器时，将发生以下两种情况之一</strong></p> <ul><li>如果<code>poll</code>队列不为空，则事件循环将遍历其同步执行它们的<code>callback</code>队列，直到队列为空，或者达到<code>system-dependent</code>（系统相关限制）。</li></ul> <p><strong>如果<code>poll</code>队列为空，则会发生以下两种情况之一</strong></p> <ul><li>如果有<code>setImmediate()</code>回调需要执行，则会立即停止执行<code>poll</code>阶段并进入执行<code>check</code>阶段以执行回调。<br></li> <li>如果没有<code>setImmediate()</code>回到需要执行，poll阶段将等待<code>callback</code>被添加到队列中，然后立即执行。<br></li></ul> <p><strong>当然设定了 timer 的话且 poll 队列为空，则会判断是否有 timer 超时，如果有的话会回到 timer 阶段执行回调。</strong> <a name="aZTtj"></a></p> <h3 id="check">check</h3> <p><strong>此阶段允许人员在poll阶段完成后立即执行回调。</strong><br>如果<code>poll</code>阶段闲置并且<code>script</code>已排队<code>setImmediate()</code>，则事件循环到达check阶段执行而不是继续等待。<br><code>setImmediate()</code>实际上是一个特殊的计时器，它在事件循环的一个单独阶段运行。它使用<code>libuv API</code>来调度在<code>poll</code>阶段完成后执行的回调。<br>通常，当代码被执行时，事件循环最终将达到<code>poll</code>阶段，它将等待传入连接，请求等。<br>但是，如果已经调度了回调<code>setImmediate()</code>，并且轮询阶段变为空闲，则它将结束并且到达<code>check</code>阶段，而不是等待<code>poll</code>事件。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timer1'</span><span class="token punctuation">)</span>
  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise1'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timer2'</span><span class="token punctuation">)</span>
  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise2'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise3'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>如果<code>node</code>版本为<code>v11.x</code>， 其结果与浏览器一致。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>start
end
promise3
timer1
promise1
timer2
promise2

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>具体详情可以查看《<a href="https://juejin.im/post/5c3e8d90f265da614274218a" target="_blank" rel="noopener noreferrer">又被node的eventloop坑了，这次是node的锅<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>》。<br>如果v10版本上述结果存在两种情况：</p> <ul><li>如果time2定时器已经在执行队列中了</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>start
end
promise3
timer1
timer2
promise1
promise2

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>如果time2定时器没有在执行对列中，执行结果为</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>start
end
promise3
timer1
promise1
timer2
promise2

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>具体情况可以参考<code>poll</code>阶段的两种情况。<br>从下图可能更好理解：<br><img src="https://cdn.nlark.com/yuque/0/2019/gif/128853/1560995436960-165cb65c-477f-4b4c-8a0a-79d3136f342e.gif#align=left&amp;display=inline&amp;height=333&amp;originHeight=333&amp;originWidth=598&amp;size=0&amp;status=done&amp;width=598" alt=""> <a name="K0Wcv"></a></p> <h2 id="setimmediate-的settimeout-的区别">setImmediate() 的setTimeout()的区别</h2> <p><strong><code>setImmediate</code>和<code>setTimeout()</code>是相似的，但根据它们被调用的时间以不同的方式表现。</strong></p> <ul><li><code>setImmediate()</code>设计用于在当前<code>poll</code>阶段完成后check阶段执行脚本 。</li> <li><code>setTimeout()</code> 安排在经过最小（ms）后运行的脚本，在<code>timers</code>阶段执行。
<a name="k9uIW"></a></li></ul> <h3 id="举个例子-2">举个例子</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>setTimeout(() =&gt; {
  console.log('timeout');
}, 0);
setImmediate(() =&gt; {
  console.log('immediate');
});

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><strong>执行定时器的顺序将根据调用它们的上下文而有所不同。 如果从主模块中调用两者，那么时间将受到进程性能的限制。</strong><br><strong>其结果也不一致</strong><br><strong>如果在<code>I / O</code>周期内移动两个调用，则始终首先执行立即回调：</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>__filename<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'timeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'immediate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>其结果可以确定一定是<code>immediate =&gt; timeout</code>。<br>主要原因是在<code>I/O阶段</code>读取文件后，事件循环会先进入<code>poll</code>阶段，发现有<code>setImmediate</code>需要执行，会立即进入<code>check</code>阶段执行<code>setImmediate</code>的回调。<br>然后再进入<code>timers</code>阶段，执行<code>setTimeout</code>，打印<code>timeout</code>。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>┌───────────────────────────┐
┌─&gt;│           timers          │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │     pending callbacks     │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │       idle, prepare       │
│  └─────────────┬─────────────┘      ┌───────────────┐
│  ┌─────────────┴─────────────┐      │   incoming:   │
│  │           poll            │&lt;─────┤  connections, │
│  └─────────────┬─────────────┘      │   data, etc.  │
│  ┌─────────────┴─────────────┐      └───────────────┘
│  │           check           │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
└──┤      close callbacks      │
   └───────────────────────────┘

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><a name="YOs2k"></a></p> <h2 id="process-nexttick">Process.nextTick()</h2> <p><strong><code>process.nextTick()</code>虽然它是异步API的一部分，但未在图中显示。这是因为<code>process.nextTick()</code>从技术上讲，它不是事件循环的一部分。</strong></p> <ul><li><code>process.nextTick()</code>方法将 <code>callback</code> 添加到<code>next tick</code>队列。 一旦当前事件轮询队列的任务全部完成，在<code>next tick</code>队列中的所有<code>callbacks</code>会被依次调用。</li></ul> <p><strong>换种理解方式：</strong></p> <ul><li>当每个阶段完成后，如果存在 <code>nextTick</code> 队列，就会清空队列中的所有回调函数，并且优先于其他 <code>microtask</code> 执行。
<a name="GCX3J"></a></li></ul> <h3 id="例子">例子</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> bar<span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setImmediate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">function</span> <span class="token function">someAsyncApiCall</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  process<span class="token punctuation">.</span><span class="token function">nextTick</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">someAsyncApiCall</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">,</span> bar<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
bar <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>在NodeV10中上述代码执行可能有两种答案，一种为：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>bar 1
setTimeout
setImmediate

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>另一种为：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>bar 1
setImmediate
setTimeout

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>无论哪种，始终都是先执行<code>process.nextTick(callback)</code>，打印<code>bar 1</code>。</p> <hr></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/zhenquan321/edit/master/src/offer/eventLoop.md" target="_blank" rel="noopener noreferrer">Found a bug? Help me improve this page!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/offer/hoisting.html" class="prev">
          JavaScript的『预解释』与『变量提升』
        </a></span> <span class="next"><a href="/offer/immutable.html">
          实现不可变数据
        </a>
        →
      </span></p></div> </div> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.239b68c1.js" defer></script><script src="/assets/js/4.d46d2a2b.js" defer></script><script src="/assets/js/98.2ad82200.js" defer></script>
  </body>
</html>
