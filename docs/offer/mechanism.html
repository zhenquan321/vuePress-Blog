<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JavaScript的运行机制 | 忙 · 南易</title>
    <meta name="description" content="">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon.png">
  <link rel="icon" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/assets/css/0.styles.8d6b1986.css" as="style"><link rel="preload" href="/assets/js/app.32a39265.js" as="script"><link rel="preload" href="/assets/js/4.91c97ad6.js" as="script"><link rel="preload" href="/assets/js/108.a38f5598.js" as="script"><link rel="prefetch" href="/assets/js/10.a9a0b542.js"><link rel="prefetch" href="/assets/js/100.4ddc6f95.js"><link rel="prefetch" href="/assets/js/101.baf8d864.js"><link rel="prefetch" href="/assets/js/102.d6bdd45e.js"><link rel="prefetch" href="/assets/js/103.7a4765c7.js"><link rel="prefetch" href="/assets/js/104.0076f34d.js"><link rel="prefetch" href="/assets/js/105.37ea1584.js"><link rel="prefetch" href="/assets/js/106.6937d385.js"><link rel="prefetch" href="/assets/js/107.e27bb9ec.js"><link rel="prefetch" href="/assets/js/109.4760b837.js"><link rel="prefetch" href="/assets/js/11.e16d36f1.js"><link rel="prefetch" href="/assets/js/110.af95c8d6.js"><link rel="prefetch" href="/assets/js/111.1d2309e8.js"><link rel="prefetch" href="/assets/js/112.fd026dc2.js"><link rel="prefetch" href="/assets/js/113.7acf6ac5.js"><link rel="prefetch" href="/assets/js/114.f33b8b58.js"><link rel="prefetch" href="/assets/js/115.6b515cb3.js"><link rel="prefetch" href="/assets/js/116.61a9a68f.js"><link rel="prefetch" href="/assets/js/117.72716890.js"><link rel="prefetch" href="/assets/js/118.dd159b7e.js"><link rel="prefetch" href="/assets/js/119.35328686.js"><link rel="prefetch" href="/assets/js/12.59548c07.js"><link rel="prefetch" href="/assets/js/120.bd03d0bc.js"><link rel="prefetch" href="/assets/js/121.830ba600.js"><link rel="prefetch" href="/assets/js/122.25d68c9d.js"><link rel="prefetch" href="/assets/js/123.588e9383.js"><link rel="prefetch" href="/assets/js/124.7b280988.js"><link rel="prefetch" href="/assets/js/125.758d01f4.js"><link rel="prefetch" href="/assets/js/126.dd7d253d.js"><link rel="prefetch" href="/assets/js/127.fba1c422.js"><link rel="prefetch" href="/assets/js/128.2d779137.js"><link rel="prefetch" href="/assets/js/129.a93548b0.js"><link rel="prefetch" href="/assets/js/13.530976fd.js"><link rel="prefetch" href="/assets/js/130.5c9234b3.js"><link rel="prefetch" href="/assets/js/14.23bb919b.js"><link rel="prefetch" href="/assets/js/15.1b5a86dd.js"><link rel="prefetch" href="/assets/js/16.7886a4de.js"><link rel="prefetch" href="/assets/js/17.d26c28db.js"><link rel="prefetch" href="/assets/js/18.9b867385.js"><link rel="prefetch" href="/assets/js/19.04ee18af.js"><link rel="prefetch" href="/assets/js/20.681970be.js"><link rel="prefetch" href="/assets/js/21.a60874f4.js"><link rel="prefetch" href="/assets/js/22.b5a61d0c.js"><link rel="prefetch" href="/assets/js/23.1b2dff34.js"><link rel="prefetch" href="/assets/js/24.16bb6ea0.js"><link rel="prefetch" href="/assets/js/25.193a1f30.js"><link rel="prefetch" href="/assets/js/26.7df041d6.js"><link rel="prefetch" href="/assets/js/27.e3082df1.js"><link rel="prefetch" href="/assets/js/28.32a19b47.js"><link rel="prefetch" href="/assets/js/29.072b210d.js"><link rel="prefetch" href="/assets/js/3.ecb205c8.js"><link rel="prefetch" href="/assets/js/30.28457682.js"><link rel="prefetch" href="/assets/js/31.df0fb764.js"><link rel="prefetch" href="/assets/js/32.4f4768b0.js"><link rel="prefetch" href="/assets/js/33.4909261f.js"><link rel="prefetch" href="/assets/js/34.673189e3.js"><link rel="prefetch" href="/assets/js/35.7f64b13c.js"><link rel="prefetch" href="/assets/js/36.ad673f09.js"><link rel="prefetch" href="/assets/js/37.892588e5.js"><link rel="prefetch" href="/assets/js/38.8b85c87a.js"><link rel="prefetch" href="/assets/js/39.7121cd98.js"><link rel="prefetch" href="/assets/js/40.a7251bda.js"><link rel="prefetch" href="/assets/js/41.92faa07b.js"><link rel="prefetch" href="/assets/js/42.6ae7b63d.js"><link rel="prefetch" href="/assets/js/43.2fd6359d.js"><link rel="prefetch" href="/assets/js/44.622f0d9d.js"><link rel="prefetch" href="/assets/js/45.72b3049d.js"><link rel="prefetch" href="/assets/js/46.a4ece7ee.js"><link rel="prefetch" href="/assets/js/47.582a063e.js"><link rel="prefetch" href="/assets/js/48.b299c19c.js"><link rel="prefetch" href="/assets/js/49.a3406d02.js"><link rel="prefetch" href="/assets/js/5.dba0af1a.js"><link rel="prefetch" href="/assets/js/50.ade65618.js"><link rel="prefetch" href="/assets/js/51.ecbe82a4.js"><link rel="prefetch" href="/assets/js/52.2a11cc4f.js"><link rel="prefetch" href="/assets/js/53.0f9a3c8c.js"><link rel="prefetch" href="/assets/js/54.ccf1eea1.js"><link rel="prefetch" href="/assets/js/55.23dda6eb.js"><link rel="prefetch" href="/assets/js/56.48a100a1.js"><link rel="prefetch" href="/assets/js/57.f2ec7dd6.js"><link rel="prefetch" href="/assets/js/58.f1acca4e.js"><link rel="prefetch" href="/assets/js/59.e651b8f0.js"><link rel="prefetch" href="/assets/js/6.2948d63f.js"><link rel="prefetch" href="/assets/js/60.dd1d38a8.js"><link rel="prefetch" href="/assets/js/61.8b688ff7.js"><link rel="prefetch" href="/assets/js/62.a0b6af2d.js"><link rel="prefetch" href="/assets/js/63.806332d5.js"><link rel="prefetch" href="/assets/js/64.cb011209.js"><link rel="prefetch" href="/assets/js/65.edc0eb99.js"><link rel="prefetch" href="/assets/js/66.4e3ec164.js"><link rel="prefetch" href="/assets/js/67.150253e0.js"><link rel="prefetch" href="/assets/js/68.b3c8cf17.js"><link rel="prefetch" href="/assets/js/69.781892ed.js"><link rel="prefetch" href="/assets/js/7.c94748a2.js"><link rel="prefetch" href="/assets/js/70.387cff74.js"><link rel="prefetch" href="/assets/js/71.96765f9a.js"><link rel="prefetch" href="/assets/js/72.d078b13e.js"><link rel="prefetch" href="/assets/js/73.1b527ad7.js"><link rel="prefetch" href="/assets/js/74.aab74a2b.js"><link rel="prefetch" href="/assets/js/75.c3b8772d.js"><link rel="prefetch" href="/assets/js/76.b2337e48.js"><link rel="prefetch" href="/assets/js/77.2ddeadcc.js"><link rel="prefetch" href="/assets/js/78.58f5a4bd.js"><link rel="prefetch" href="/assets/js/79.d2915b24.js"><link rel="prefetch" href="/assets/js/8.42abcc83.js"><link rel="prefetch" href="/assets/js/80.3326f5ab.js"><link rel="prefetch" href="/assets/js/81.9edc96c8.js"><link rel="prefetch" href="/assets/js/82.2fa0fbab.js"><link rel="prefetch" href="/assets/js/83.f0eb0cc8.js"><link rel="prefetch" href="/assets/js/84.7858354a.js"><link rel="prefetch" href="/assets/js/85.4176cc9d.js"><link rel="prefetch" href="/assets/js/86.8aa6b18f.js"><link rel="prefetch" href="/assets/js/87.f0bebb4e.js"><link rel="prefetch" href="/assets/js/88.d74d5bac.js"><link rel="prefetch" href="/assets/js/89.63f2f7b2.js"><link rel="prefetch" href="/assets/js/9.5e7d4f9e.js"><link rel="prefetch" href="/assets/js/90.076eaea2.js"><link rel="prefetch" href="/assets/js/91.8f13fee6.js"><link rel="prefetch" href="/assets/js/92.38181e7b.js"><link rel="prefetch" href="/assets/js/93.5b7d6c4e.js"><link rel="prefetch" href="/assets/js/94.c29ad5bd.js"><link rel="prefetch" href="/assets/js/95.8198b8cb.js"><link rel="prefetch" href="/assets/js/96.d6cbe1d3.js"><link rel="prefetch" href="/assets/js/97.72af1449.js"><link rel="prefetch" href="/assets/js/98.f3d2c1ea.js"><link rel="prefetch" href="/assets/js/99.a9171fcf.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.9c5dedbe.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8d6b1986.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/vuepress-blog-logo.png" alt="忙 · 南易" class="logo"> <span class="site-name can-hide">忙 · 南易</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/node/" class="nav-link">node</a></div><div class="nav-item"><a href="/offer/" class="nav-link router-link-active">offer之道</a></div><div class="nav-item"><a href="/interviewQuestions/bytedance.html" class="nav-link">大厂真题</a></div> <a href="https://github.com/zhenquan321/node-ts-dome.git" target="_blank" rel="noopener noreferrer" class="repo-link">
    Git
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/node/" class="nav-link">node</a></div><div class="nav-item"><a href="/offer/" class="nav-link router-link-active">offer之道</a></div><div class="nav-item"><a href="/interviewQuestions/bytedance.html" class="nav-link">大厂真题</a></div> <a href="https://github.com/zhenquan321/node-ts-dome.git" target="_blank" rel="noopener noreferrer" class="repo-link">
    Git
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>前言</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/offer/" class="sidebar-link">声明·感谢：</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>面试技巧</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>推荐</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>前端基础</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>前端基础笔试</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>前端原理详解</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/offer/hoisting.html" class="sidebar-link">JavaScript的『预解释』与『变量提升』</a></li><li><a href="/offer/eventLoop.html" class="sidebar-link">Event Loop详解</a></li><li><a href="/offer/immutable.html" class="sidebar-link">实现不可变数据</a></li><li><a href="/offer/memory.html" class="sidebar-link">JavaScript内存管理</a></li><li><a href="/offer/deepclone.html" class="sidebar-link">实现深克隆</a></li><li><a href="/offer/event.html" class="sidebar-link">如何实现一个Event</a></li><li><a href="/offer/mechanism.html" class="active sidebar-link">JavaScript的运行机制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/offer/mechanism.html#javascript的执行环境" class="sidebar-link">JavaScript的执行环境</a></li><li class="sidebar-sub-header"><a href="/offer/mechanism.html#javascript执行" class="sidebar-link">JavaScript执行</a></li><li class="sidebar-sub-header"><a href="/offer/mechanism.html#小结" class="sidebar-link">小结</a></li></ul></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>计算机基础</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>数据结构与算法</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>前端框架</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>框架原理详解</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>框架实战技巧</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>工程化</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>工程化原理</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>安全</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content default"><h1 id="javascript的运行机制">JavaScript的运行机制</h1> <p>了解JavaScript运行机制有助于我们避免bug，并写出高性能的代码，当然还有一大用处就是有助于我们通过造火箭环节的面试。</p> <p>具体而言你会搞清楚以下问题：</p> <ul><li>作用域链本质上是如何产生的</li> <li>this是如何被绑定的</li> <li>JavaScript代码到底运行原理是什么</li> <li>闭包产生的根本原因</li></ul> <p>而产生的『后果』是，你可以应对几乎所有的JavaScript作用域、闭包、执行等层面的面试题，还有一个可能的后果，就是面对复杂度不是那么高的代码时，你的脑子中会自己把执行过程像放动画一样过一遍（虽然这个动画也不非常准确）。</p> <h2 id="javascript的执行环境">JavaScript的执行环境</h2> <p>在了解JavaScript运行机制之前，我们需要搞清楚几个主要概念，这有助于我们接下来的理解。</p> <h3 id="javascript引擎-javascript-engine">JavaScript引擎(JavaScript Engine)</h3> <p>赋予一段代码意义的正是JavaScript引擎，目前JavaScript引擎有许多种:</p> <ul><li>V8 — 开源，由 Google 开发，用 C ++ 编写</li> <li>Rhino — 由 Mozilla 基金会管理，开源，完全用 Java 开发</li> <li>SpiderMonkey — 是第一个支持 Netscape Navigator 的 JavaScript 引擎，目前正供 Firefox 使用</li> <li>JavaScriptCore — 开源，以Nitro形式销售，由苹果为Safari开发</li> <li>KJS — KDE 的引擎，最初由 Harri Porten 为 KDE 项目中的 Konqueror 网页浏览器开发</li> <li>Chakra (JScript9) — Internet Explorer</li> <li>Chakra (JavaScript) — Microsoft Edge</li> <li>Nashorn, 作为 OpenJDK 的一部分，由 Oracle Java 语言和工具组编写</li> <li>JerryScript —  物联网的轻量级引擎</li></ul> <p>而最为大家熟知的无疑是V8引擎，他用于Chrome浏览器和Node中。</p> <p><img src="https://xiaomuzhu-image.oss-cn-beijing.aliyuncs.com/27d902eae39383d1e92d05f4be51ce9b.png" alt="2019-06-19-13-00-37"></p> <p>V8引擎由两个主要部件组成:</p> <ul><li>emory Heap(内存堆) — 内存分配地址的地方</li> <li>Call Stack(调用堆栈) — 代码执行的地方</li></ul> <h3 id="javascript运行时（javascript-runtime）">JavaScript运行时（JavaScript Runtime）</h3> <p>想让JavaScript真正运作起来，单单靠JavaScript Engine是不够的，JavaScript Engine的工作是<strong>编译并执行 JavaScript 代码，完成内存分配、垃圾回收等</strong>,但是缺乏与外部交互的能力。</p> <p>比如单靠一个V8引擎是无法进行ajax请求、设置定时器、响应事件等操作的，这就需要JavaScript运行时（JavaScript Runtime）的帮助，它为 JavaScript 提供一些对象或机制，使它能够与外界交互。</p> <p>比如，虽然Chrome和node都是用了V8引擎，但是他们的运行时却不同，比如process、fs浏览器都无法提供。</p> <h3 id="可执行代码">可执行代码</h3> <p>一段JavaScript代码的运行我们可以分为两个阶段:</p> <ul><li><p>编译阶段：</p> <ul><li>分词/词法分析（Tokenizing/Lexing）</li> <li>解析/语法分析（Parsing）</li> <li>预编译（解释）</li></ul></li> <li><p>执行阶段</p></li></ul> <p>本文的重点在于执行阶段。</p> <p>JavaScript并非简单的一行行解释执行，而是将JavaScript代码分为一块块的可执行代码块进行执行，那么如何划分代码块？</p> <p>目前有三类代码块：</p> <ul><li>函数代码块（Function code）</li> <li>全局代码块（Global code）</li> <li>eval代码块（Eval code）</li></ul> <h2 id="javascript执行">JavaScript执行</h2> <p>我们先看一个简单的例子：</p> <p><img src="https://xiaomuzhu-image.oss-cn-beijing.aliyuncs.com/2a165649e1648896c43cd0b5ce9f33d9.png" alt="2019-06-20-08-15-59"></p> <p>看到这个例子思考一下JavaScript应该是如何执行它的？</p> <p>如果你头脑里没有任何细节的概念，那么接下来的内容就很适用于你了。</p> <h3 id="堆">堆</h3> <p>我们之前提到过JavaScript引擎两个重要部分：</p> <ul><li>emory Heap(内存堆) — 内存分配地址的地方</li> <li>Call Stack(调用栈) — 代码执行的地方</li></ul> <p>而上面的代码声明正是被存放在『堆』中。</p> <p><img src="https://xiaomuzhu-image.oss-cn-beijing.aliyuncs.com/65c06e0194c7f94e7af45e8fcb30e004.png" alt="2019-06-20-00-15-33"></p> <p>此时虽然变量和函数都被声明了，但是函数还没有执行，我们现在执行<code>say</code>函数。</p> <p><img src="https://xiaomuzhu-image.oss-cn-beijing.aliyuncs.com/cb4772803d189080a33facfeecd11baa.png" alt="2019-06-20-08-16-47"></p> <p>那么接下来又会发生什么呢？</p> <h3 id="调用栈">调用栈</h3> <p>调用栈(Call Stack)这个概念对于经常调试JavaScript代码的同学应该不陌生。</p> <p><img src="https://xiaomuzhu-image.oss-cn-beijing.aliyuncs.com/7e4050faa0d3ed66965ad08bf2fec42e.png" alt="2019-06-20-00-22-23"></p> <p>我们声明的函数与变量被储存在『内存堆』中，而当我们要执行的时候，就必须借助于『调用栈』来解决问题。</p> <p>如果熟悉数据结构的同学应该知道，栈是一个基础的数据结构，它的特点就是先进后出。</p> <p>我们仍然看这个例子，当<code>say</code>函数被调用的时候，他会被压入栈底。</p> <p><img src="https://xiaomuzhu-image.oss-cn-beijing.aliyuncs.com/14c76ec0f423e439cf0df59ad8548f8b.png" alt="2019-06-20-00-29-02"></p> <p>那么是不是将函数压入栈内就结束了？肯定没有这么简单，这里需
要在引入一个概念，执行上下文(execution context)。</p> <h3 id="执行上下文-execution-context">执行上下文(execution context)</h3> <p>执行上下文在代码块执行前创建，作为代码块运行的基本执行环境，那么执行上下文分为几种？</p> <p>前面我们提到过，JavaScript中有三种可执行代码块，当然也对应着三种执行上下文。</p> <ul><li>全局执行上下文 — 这是基础上下文，任何不在函数内部的代码都在全局上下文中。它会执行两件事：创建一个全局的 window 对象（浏览器的情况下），并且设置 this 的值等于这个全局对象。一个程序中只会有一个全局执行上下文。</li> <li>函数执行上下文 — 每当一个函数被调用时, 都会为该函数创建一个新的上下文。每个函数都有它自己的执行上下文，不过是在函数被调用时创建的。函数上下文可以有任意多个。每当一个新的执行上下文被创建。</li> <li>Eval 执行上下文 — 执行在 eval 内部的代码也会有它属于自己的执行上下文，除非你想搞黑魔法，不然不要轻易使用它。</li></ul> <p>肯定会有人好奇，这个执行上下文到底包含哪些东西呢，他是如何运行的呢？</p> <p>执行上下文分为两个阶段：</p> <ul><li>创建阶段</li> <li>执行阶段</li></ul> <p>我们主要讨论创建阶段，执行阶段的主要工作就是分配变量</p> <h4 id="执行上下文的创建阶段">执行上下文的创建阶段</h4> <p>执行上下文的创建阶段主要解决以下三点:</p> <ul><li>决定 this 的指向</li> <li>创建词法环境(LexicalEnvironment)</li> <li>创建变量环境(VariableEnvironment)</li></ul> <blockquote><p>你可能在一些过时的教材或者文章中见过变量对象（VO）这种说法，它的意思与词法环境类似，但是那是ES3的标准，现在早已经改了，改变的原因讨论如下<a href="https://stackoverflow.com/questions/40544709/why-variable-object-was-changed-to-lexical-environment-in-es5" target="_blank" rel="noopener noreferrer">Why variable object was changed to lexical environment in ES5?<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>伪代码如下:</p> <p><img src="https://xiaomuzhu-image.oss-cn-beijing.aliyuncs.com/58ff3a1b54232bf835e0eda470404691.png" alt="2019-06-20-08-17-34"></p> <h5 id="this指向">this指向</h5> <p>我们应该知道this的指向是在代码执行阶段确定的，所谓的『代码执行阶段』正是『执行上下文的创建阶段』。</p> <p>默认情况下this指向全局对象，比如浏览器中的window.</p> <p>此外可能存在隐式绑定的情况，比如通过对象调用函数：</p> <p><img src="https://xiaomuzhu-image.oss-cn-beijing.aliyuncs.com/17ac778f64d12da5c024b4fc310c2578.png" alt="2019-06-20-08-18-09"></p> <p>这个时候this指向对象。</p> <p>然后就是显示绑定对象（call apply bind）等，最后优先级最高的就是new调用构造函数生成一个对象。</p> <h5 id="词法环境-lexicalenvironment">词法环境(LexicalEnvironment)</h5> <p>词法环境分为三大类：</p> <ul><li>全局环境：全局环境的外部环境引用是 null，它拥有内建的 Object/Array/等、在环境记录器内的原型函数（关联全局对象，比如 window 对象）还有任何用户定义的全局变量，并且 this的值指向全局对象。</li> <li>模块环境：包含模块顶级声明的绑定以及模块显式导入的绑定。 模块环境的外部环境是全局环境。</li> <li>函数环境：函数内部用户定义的变量存储在环境记录器中，外部引用既可以是其它函数的内部词法环境，也可以是全局词法环境</li></ul> <p>词法环境本身包括两个部分：</p> <ul><li>『环境记录器（Environment Record）』是存储变量和函数声明的实际位置</li> <li>『外部环境的引用（outer Lexical Environment）』指它可以访问其父级词法环境（即作用域）</li></ul> <p>对于『环境记录器』而言，它又分为两个主要的环境记录器类型：</p> <ul><li>声明式环境记录器（DecarativeEnvironmentRecord）：范围包含函数定义，变量声明，try...catch等，此类型对应其范围内包含的声明定义的标识符集</li> <li>对象式环境记录器（ObjectEnvironmentRecord）：由程序级别的（Program）对象、声明、with语句等创建，与称为其绑定对象的对象相关联，此类型对应于其绑定对象的属性名称的字符串标识符名称集</li></ul> <p>比如我们在全局声明一个函数:</p> <p><img src="https://xiaomuzhu-image.oss-cn-beijing.aliyuncs.com/90c3f805aeba811d2b75097a5b3fba48.png" alt="2019-06-20-08-18-42"></p> <p>那么他的词法环境可以这样表示（下图我们省略了this绑定、变量环境等信息，便于理解）：</p> <p><img src="https://xiaomuzhu-image.oss-cn-beijing.aliyuncs.com/f2fd3a92e2aa96c5005d525389834a57.png" alt="2019-06-20-03-49-33"></p> <h5 id="变量环境-variableenvironment">变量环境(VariableEnvironment)</h5> <p>变量环境的定义在es5标准和es6标准是略有不同的，我们采用<a href="http://www.ecma-international.org/ecma-262/6.0/#sec-for-statement-runtime-semantics-labelledevaluation" target="_blank" rel="noopener noreferrer">es6的标准<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>变量环境也是一个词法环境，但不同的是词法环境被用来存储函数声明和变量（let 和 const）绑定，而变量环境只用来存储 var 变量绑定。</p> <h3 id="执行过程">执行过程</h3> <p>在了解了这么多概念之后，我们就可以把本节开头的例子再拓展一下：</p> <p><img src="https://xiaomuzhu-image.oss-cn-beijing.aliyuncs.com/8532b28d02cf78652a370c82a6c2d29a.png" alt="2019-06-20-08-19-15"></p> <p>我们就一步步复盘一下上述代码是如何执行的（不考虑解析、预解释等操作，只考虑执行）:</p> <ol><li>变量<code>name</code>和函数声明<code>say</code>被白存在堆中。</li></ol> <p><img src="https://xiaomuzhu-image.oss-cn-beijing.aliyuncs.com/e1f42e04400e14c49c32f51327f85789.png" alt="2019-06-20-05-23-40"></p> <ol start="2"><li>创建全局可执行上下文:</li></ol> <p>全局上下文的伪代码如下:</p> <p><img src="https://xiaomuzhu-image.oss-cn-beijing.aliyuncs.com/2fd22918e0c60c3dacf7fdf3c2c28c3b.png" alt="2019-06-20-08-19-53"></p> <p>示意图:</p> <p><img src="https://xiaomuzhu-image.oss-cn-beijing.aliyuncs.com/ac8d769de3c77bd724b0f98221c3f8d6.png" alt="2019-06-20-05-48-54"></p> <ol start="3"><li>创建函数执行上下文</li></ol> <p>say函数的执行上下文伪代码如下:</p> <p><img src="https://xiaomuzhu-image.oss-cn-beijing.aliyuncs.com/e3dd5ee7ef882c94d27ed55a546779d5.png" alt="2019-06-20-08-20-53"></p> <ol start="4"><li>创建创建say函数体内的函数执行上下文</li></ol> <p>play函数的执行上下文伪代码如下</p> <p><img src="https://xiaomuzhu-image.oss-cn-beijing.aliyuncs.com/885a56c1ebb11cfbc1588d5f51fbaee9.png" alt="2019-06-20-08-21-45"></p> <p>示意图：</p> <p><img src="https://xiaomuzhu-image.oss-cn-beijing.aliyuncs.com/0f1701f3b7061942ae24a9357f28bc2e.png" alt="2019-06-20-06-00-27"></p> <ol start="5"><li>开始执行</li></ol> <p>将上下文中的变量赋值，然后执行代码，执行完毕栈顶的play函数后弹出，接着执行say函数，完毕后弹出。</p> <h2 id="小结">小结</h2> <p>我们通过本文了解了相关的JavaScript执行机制，现在可以回答这几个问题了。</p> <h3 id="this是怎么被绑定的">this是怎么被绑定的?</h3> <p>在创建可执行上下文的时候，根据代码的执行条件，来判断分别进行默认绑定、隐式绑定、显示绑定等。</p> <h3 id="作用域链是怎么形成的？">作用域链是怎么形成的？</h3> <p>可执行上下文中的词法环境中含有外部词法环境的引用，我们可以通过这个引用获取外部词法环境的变量、声明等，这些引用串联起来一直指向全局的词法环境，因此形成了作用域链。</p> <h3 id="闭包是怎么形成的？">闭包是怎么形成的？</h3> <p>可执行上下文中的词法环境中含有外部词法环境的引用，我们可以通过这个引用获取外部词法环境的变量、声明等，因此形成了闭包。</p> <hr> <p>参考</p> <ol><li><a href="http://www.ecma-international.org/ecma-262/6.0/#sec-for-statement-runtime-semantics-labelledevaluation" target="_blank" rel="noopener noreferrer">ecma标准<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.valentinog.com/blog/engines/" target="_blank" rel="noopener noreferrer">JavaScript调用栈到异步<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ol> <hr></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/zhenquan321/node-ts-dome.git/edit/master/src/offer/mechanism.md" target="_blank" rel="noopener noreferrer">Found a bug? Help me improve this page!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/offer/event.html" class="prev">
          如何实现一个Event
        </a></span> <span class="next"><a href="/offer/http.html">
          HTTP协议
        </a>
        →
      </span></p></div> </div> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.32a39265.js" defer></script><script src="/assets/js/4.91c97ad6.js" defer></script><script src="/assets/js/108.a38f5598.js" defer></script>
  </body>
</html>
