<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>如何开发Babel插件 | 忙 · 南易</title>
    <meta name="description" content="">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon.png">
  <link rel="icon" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
    
    <link rel="preload" href="/assets/css/0.styles.3bc9ddec.css" as="style"><link rel="preload" href="/assets/js/app.f01571a1.js" as="script"><link rel="preload" href="/assets/js/4.d35f8dd4.js" as="script"><link rel="preload" href="/assets/js/81.17c51564.js" as="script"><link rel="prefetch" href="/assets/js/10.f716e581.js"><link rel="prefetch" href="/assets/js/100.68ce6476.js"><link rel="prefetch" href="/assets/js/101.c9382373.js"><link rel="prefetch" href="/assets/js/102.7368c139.js"><link rel="prefetch" href="/assets/js/103.8cc25b2e.js"><link rel="prefetch" href="/assets/js/104.96d4cf56.js"><link rel="prefetch" href="/assets/js/105.8d18ff58.js"><link rel="prefetch" href="/assets/js/106.ff25056e.js"><link rel="prefetch" href="/assets/js/107.83fbdaa8.js"><link rel="prefetch" href="/assets/js/108.32d0f773.js"><link rel="prefetch" href="/assets/js/109.2012270c.js"><link rel="prefetch" href="/assets/js/11.85289d99.js"><link rel="prefetch" href="/assets/js/110.b60cd56b.js"><link rel="prefetch" href="/assets/js/111.5cf5dc6a.js"><link rel="prefetch" href="/assets/js/112.4f360dd5.js"><link rel="prefetch" href="/assets/js/113.393042fc.js"><link rel="prefetch" href="/assets/js/114.182fb510.js"><link rel="prefetch" href="/assets/js/115.ea8fa99e.js"><link rel="prefetch" href="/assets/js/116.8e211826.js"><link rel="prefetch" href="/assets/js/117.21c2dd7e.js"><link rel="prefetch" href="/assets/js/118.93a1d01f.js"><link rel="prefetch" href="/assets/js/119.9ce96fa4.js"><link rel="prefetch" href="/assets/js/12.0f540617.js"><link rel="prefetch" href="/assets/js/120.11476eb2.js"><link rel="prefetch" href="/assets/js/121.4417a938.js"><link rel="prefetch" href="/assets/js/122.5fdf52a4.js"><link rel="prefetch" href="/assets/js/123.9b7fb3c8.js"><link rel="prefetch" href="/assets/js/124.020624a9.js"><link rel="prefetch" href="/assets/js/125.d693ebf3.js"><link rel="prefetch" href="/assets/js/126.7d3707bb.js"><link rel="prefetch" href="/assets/js/127.c288d806.js"><link rel="prefetch" href="/assets/js/128.ae10af8b.js"><link rel="prefetch" href="/assets/js/129.c1ebf181.js"><link rel="prefetch" href="/assets/js/13.1ceaa040.js"><link rel="prefetch" href="/assets/js/130.c4bd1a32.js"><link rel="prefetch" href="/assets/js/131.663b184f.js"><link rel="prefetch" href="/assets/js/132.b8e4b135.js"><link rel="prefetch" href="/assets/js/133.4382d00b.js"><link rel="prefetch" href="/assets/js/14.52dfd47d.js"><link rel="prefetch" href="/assets/js/15.a875ea8d.js"><link rel="prefetch" href="/assets/js/16.55034f5c.js"><link rel="prefetch" href="/assets/js/17.e32af7f0.js"><link rel="prefetch" href="/assets/js/18.0da9ac99.js"><link rel="prefetch" href="/assets/js/19.9e760968.js"><link rel="prefetch" href="/assets/js/20.e5b59490.js"><link rel="prefetch" href="/assets/js/21.b6160b89.js"><link rel="prefetch" href="/assets/js/22.6a432490.js"><link rel="prefetch" href="/assets/js/23.975d0a3d.js"><link rel="prefetch" href="/assets/js/24.f12bca20.js"><link rel="prefetch" href="/assets/js/25.5816689a.js"><link rel="prefetch" href="/assets/js/26.dc6f100d.js"><link rel="prefetch" href="/assets/js/27.fa8657ff.js"><link rel="prefetch" href="/assets/js/28.f0e6374d.js"><link rel="prefetch" href="/assets/js/29.736b42c1.js"><link rel="prefetch" href="/assets/js/3.818110a1.js"><link rel="prefetch" href="/assets/js/30.abd0db50.js"><link rel="prefetch" href="/assets/js/31.f1f43a81.js"><link rel="prefetch" href="/assets/js/32.4847c5ca.js"><link rel="prefetch" href="/assets/js/33.7a4c7c95.js"><link rel="prefetch" href="/assets/js/34.a11fa3d8.js"><link rel="prefetch" href="/assets/js/35.42c002e5.js"><link rel="prefetch" href="/assets/js/36.623669db.js"><link rel="prefetch" href="/assets/js/37.439e9f52.js"><link rel="prefetch" href="/assets/js/38.4f59c970.js"><link rel="prefetch" href="/assets/js/39.2a55c857.js"><link rel="prefetch" href="/assets/js/40.f633203a.js"><link rel="prefetch" href="/assets/js/41.24331d8e.js"><link rel="prefetch" href="/assets/js/42.e67e076b.js"><link rel="prefetch" href="/assets/js/43.f67a1a96.js"><link rel="prefetch" href="/assets/js/44.dc43f3aa.js"><link rel="prefetch" href="/assets/js/45.68e6767d.js"><link rel="prefetch" href="/assets/js/46.bd132cd7.js"><link rel="prefetch" href="/assets/js/47.b6430d42.js"><link rel="prefetch" href="/assets/js/48.355dda46.js"><link rel="prefetch" href="/assets/js/49.ed9015a3.js"><link rel="prefetch" href="/assets/js/5.91b99676.js"><link rel="prefetch" href="/assets/js/50.deb74294.js"><link rel="prefetch" href="/assets/js/51.be6e035f.js"><link rel="prefetch" href="/assets/js/52.5fe11386.js"><link rel="prefetch" href="/assets/js/53.4dea4a3d.js"><link rel="prefetch" href="/assets/js/54.f240dbc3.js"><link rel="prefetch" href="/assets/js/55.9322531f.js"><link rel="prefetch" href="/assets/js/56.7c9c7776.js"><link rel="prefetch" href="/assets/js/57.22d55f9c.js"><link rel="prefetch" href="/assets/js/58.3bd0561c.js"><link rel="prefetch" href="/assets/js/59.87bfc4a3.js"><link rel="prefetch" href="/assets/js/6.8807c3c3.js"><link rel="prefetch" href="/assets/js/60.36bf245a.js"><link rel="prefetch" href="/assets/js/61.d70ec82a.js"><link rel="prefetch" href="/assets/js/62.43d27471.js"><link rel="prefetch" href="/assets/js/63.15615931.js"><link rel="prefetch" href="/assets/js/64.2b2712bb.js"><link rel="prefetch" href="/assets/js/65.05570463.js"><link rel="prefetch" href="/assets/js/66.680a827f.js"><link rel="prefetch" href="/assets/js/67.d0e04f8d.js"><link rel="prefetch" href="/assets/js/68.e3d3278f.js"><link rel="prefetch" href="/assets/js/69.8262245f.js"><link rel="prefetch" href="/assets/js/7.62191691.js"><link rel="prefetch" href="/assets/js/70.db038b49.js"><link rel="prefetch" href="/assets/js/71.2f15417e.js"><link rel="prefetch" href="/assets/js/72.c2a6ba88.js"><link rel="prefetch" href="/assets/js/73.0ace2fd9.js"><link rel="prefetch" href="/assets/js/74.800951f9.js"><link rel="prefetch" href="/assets/js/75.5c553fe1.js"><link rel="prefetch" href="/assets/js/76.974cbaaf.js"><link rel="prefetch" href="/assets/js/77.ec3d1c1c.js"><link rel="prefetch" href="/assets/js/78.991c5f72.js"><link rel="prefetch" href="/assets/js/79.300d226f.js"><link rel="prefetch" href="/assets/js/8.8bfeba88.js"><link rel="prefetch" href="/assets/js/80.5e82656b.js"><link rel="prefetch" href="/assets/js/82.ac01936b.js"><link rel="prefetch" href="/assets/js/83.6ee355e4.js"><link rel="prefetch" href="/assets/js/84.4098e049.js"><link rel="prefetch" href="/assets/js/85.94604e84.js"><link rel="prefetch" href="/assets/js/86.6f24c1d6.js"><link rel="prefetch" href="/assets/js/87.72e2b583.js"><link rel="prefetch" href="/assets/js/88.f4c83060.js"><link rel="prefetch" href="/assets/js/89.1cdc0017.js"><link rel="prefetch" href="/assets/js/9.322cdb67.js"><link rel="prefetch" href="/assets/js/90.d2ab0bcc.js"><link rel="prefetch" href="/assets/js/91.c22fd22b.js"><link rel="prefetch" href="/assets/js/92.1fa5bd89.js"><link rel="prefetch" href="/assets/js/93.d6053dc4.js"><link rel="prefetch" href="/assets/js/94.873d17dc.js"><link rel="prefetch" href="/assets/js/95.58123100.js"><link rel="prefetch" href="/assets/js/96.f57d1f3c.js"><link rel="prefetch" href="/assets/js/97.eb3ec4fc.js"><link rel="prefetch" href="/assets/js/98.55d2111d.js"><link rel="prefetch" href="/assets/js/99.9bfc140a.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.9c5dedbe.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3bc9ddec.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.png" alt="忙 · 南易" class="logo"> <span class="site-name can-hide">忙 · 南易</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/node/" class="nav-link">node</a></div><div class="nav-item"><a href="/offer/" class="nav-link router-link-active">offer之道</a></div><div class="nav-item"><a href="/interviewQuestions/bytedance.html" class="nav-link">大厂真题</a></div> <a href="https://github.com/zhenquan321/node-ts-dome.git" target="_blank" rel="noopener noreferrer" class="repo-link">
    Git
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/node/" class="nav-link">node</a></div><div class="nav-item"><a href="/offer/" class="nav-link router-link-active">offer之道</a></div><div class="nav-item"><a href="/interviewQuestions/bytedance.html" class="nav-link">大厂真题</a></div> <a href="https://github.com/zhenquan321/node-ts-dome.git" target="_blank" rel="noopener noreferrer" class="repo-link">
    Git
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>前言</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/offer/" class="sidebar-link">声明·感谢：</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>面试技巧</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>推荐</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>前端基础</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>前端基础笔试</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>前端原理详解</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>计算机基础</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>数据结构与算法</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>前端框架</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>框架原理详解</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>框架实战技巧</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>性能优化</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>工程化</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>工程化原理</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/offer/ast.html" class="sidebar-link">如何写一个babel</a></li><li><a href="/offer/WebpackHMR.html" class="sidebar-link">Webpack HMR 原理解析</a></li><li><a href="/offer/webpackPlugin.html" class="sidebar-link">webpack插件编写</a></li><li><a href="/offer/webpackPluginDesign.html" class="sidebar-link">webpack 插件化设计</a></li><li><a href="/offer/webpackMoudle.html" class="sidebar-link">Webpack 模块机制</a></li><li><a href="/offer/webpackLoader.html" class="sidebar-link">webpack loader实现</a></li><li><a href="/offer/babelPlugin.html" class="active sidebar-link">如何开发Babel插件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/offer/babelPlugin.html#语言概述" class="sidebar-link">语言概述</a></li><li class="sidebar-sub-header"><a href="/offer/babelPlugin.html#babel-概述" class="sidebar-link">Babel 概述</a></li><li class="sidebar-sub-header"><a href="/offer/babelPlugin.html#什么是抽象语法树（ast）" class="sidebar-link">什么是抽象语法树（AST）</a></li><li class="sidebar-sub-header"><a href="/offer/babelPlugin.html#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/offer/babelPlugin.html#数组" class="sidebar-link">数组</a></li><li class="sidebar-sub-header"><a href="/offer/babelPlugin.html#对象" class="sidebar-link">对象</a></li><li class="sidebar-sub-header"><a href="/offer/babelPlugin.html#赋值" class="sidebar-link">赋值</a></li><li class="sidebar-sub-header"><a href="/offer/babelPlugin.html#成员" class="sidebar-link">成员</a></li><li class="sidebar-sub-header"><a href="/offer/babelPlugin.html#结尾" class="sidebar-link">结尾</a></li></ul></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>安全</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content default"><h1 id="如何开发babel插件">如何开发Babel插件</h1> <p>本文来源于<a href="https://www.zcfy.cc/article/347" target="_blank" rel="noopener noreferrer">通过开发 Babel 插件理解抽象语法树（AST）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>,原文来源于<a href="https://www.sitepoint.com/understanding-asts-building-babel-plugin/" target="_blank" rel="noopener noreferrer">understanding-asts-building-babel-plugin<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <hr> <p>每天数以千计的 JavaScript 开发者使用的语言版本现在浏览器都还没有完全实现，许多他们使用的语言特性仅仅还只是建议，并没有保证说一定会纳入规范。因为有 Babel 项目使现在就能使用这些特性变成了可能。<br>Babel 是我们知道的将 ES6 代码转译为 ES5 代码且能安全稳定运行最好的工具，同时它允许开发者开发插件，能够在编译时期转换 JavaScript 的结构。<br>现在，我们来看看如何开发一个给 JavaScript 添加默认不可变数据的 Babel 插件，代码可以从 <a href="https://github.com/sitepoint-editors/moriscript" target="_blank" rel="noopener noreferrer">GitHub repo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 下载。
<a name="LFdKz"></a></p> <h2 id="语言概述">语言概述</h2> <p>我们想设计一个通过 <a href="http://www.sitepoint.com/immutable-data-functional-javascript-mori/" target="_blank" rel="noopener noreferrer">Mori<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 将普通对象和数组字面量转换为持久数据结构的插件。<br>我们希望写出来的代码类似这样：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> baz <span class="token operator">=</span> foo<span class="token punctuation">.</span>a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
foo<span class="token punctuation">.</span>a <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">;</span>
baz<span class="token punctuation">.</span>a <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>然后将代码转换为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> foo <span class="token operator">=</span> mori<span class="token punctuation">.</span><span class="token function">hashMap</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> baz <span class="token operator">=</span> mori<span class="token punctuation">.</span><span class="token function">assoc</span><span class="token punctuation">(</span>foo<span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mori<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>foo<span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">;</span>
mori<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>baz<span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">2</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>我们借助 <em>MoriScript</em> 来开始吧。
<a name="a06UI"></a></p> <h2 id="babel-概述">Babel 概述</h2> <p>如果我们想更深入的了解 Babel，我们需要知道 3 个处理流程中很重要的工具。<br><img src="https://cdn.nlark.com/yuque/0/2019/png/128853/1565281206766-207e0e64-8da2-4631-921d-134fc227231f.png#align=left&amp;display=inline&amp;height=228&amp;originHeight=228&amp;originWidth=880&amp;size=0&amp;status=done&amp;width=880" alt=""> <a name="9M02C"></a></p> <h3 id="解析">解析</h3> <p><a href="https://github.com/babel/babylon" target="_blank" rel="noopener noreferrer">Babylon<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是一个解析器，它可以将 JavaScript 字符串转换为对计算机来说更加友好的表现形式，称之为抽象语法树（AST）。
<a name="pKjBZ"></a></p> <h3 id="转换">转换</h3> <p><a href="https://www.npmjs.com/package/babel-traverse" target="_blank" rel="noopener noreferrer">babel-traverse<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 模块允许你浏览、分析和修改抽象语法树（AST）。
<a name="f8Peb"></a></p> <h3 id="生成">生成</h3> <p>最后，<a href="https://www.npmjs.com/package/babel-generator" target="_blank" rel="noopener noreferrer">babel-generator<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 模块用来将转换后的抽象语法树（AST）转换为 JavaScript 字符串。
<a name="bB5kX"></a></p> <h2 id="什么是抽象语法树（ast）">什么是抽象语法树（AST）</h2> <p>在继续本教程之前，我们有必要先了解抽象语法树（AST）的用途，所以先来看看它是什么以及我们为什么需要它。<br>JavaScript 程序通常是由一系列的字符组成的，每一个在我们的大脑中都有一些可视的含义。这对我们来说非常方便，可以让我们使用匹配的字符（<code>[]</code>, <code>{}</code>, <code>()</code>），成对的字符（<code>''</code>, <code>&quot;&quot;</code>）和缩进让程序解析起来更加简单。<br>然而，这对计算机来说并不是很有用，这些字符在内存中仅仅是个数值，而且计算机也不能询问一些像『在这个申明中有多少个变量』这种高级的问题。所以我们需要一些妥协，寻找一种可以让我们编程同时让计算机也能理解的方式。<br>我们来看看下面的代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
a <span class="token operator">+</span> <span class="token number">5</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>当我们把这个代码转换成抽象语法树（AST）的时候，会得到一个类似下面的结构图：<br><img src="https://cdn.nlark.com/yuque/0/2019/png/128853/1565281206766-78776ee0-0d15-4914-9d52-ff44fc0f4d19.png#align=left&amp;display=inline&amp;height=531&amp;originHeight=531&amp;originWidth=600&amp;size=0&amp;status=done&amp;width=600" alt=""><br>所有的抽象语法树（AST）根节点都是 <code>Program</code> 节点，这个节点包含了所有的最顶层语句。这个例子中，包含了 2 部分：</p> <ol><li>一个变量声明，将标识符 <code>a</code> 赋值为数值 <code>3</code>。<br></li> <li>一个二元表达式语句，描述为标志符为 <code>a</code>，操作符 <code>+</code> 和数值 <code>5</code>。<br></li></ol> <p>尽管它们看上去只是由一些简单的元素组成的，对应的抽象语法树（AST）通常情况下也比较复杂，尤其是一些复杂的程序。我们不要试图自己去分析抽象语法树（AST），可以通过 <a href="https://astexplorer.net/" target="_blank" rel="noopener noreferrer">astexplorer.net<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 网站帮助我们来完成，它允许我们在左边输入 JavaScript 代码，右侧会出可浏览的抽象语法树（AST），我们可以通过这个工具辅助理解和试验一些代码。<br><em>为了保持使用 Babel 的一致性，确保选择的解析器为 &quot;babylon6&quot;</em><br>当我们开发 Babel 插件时，我们的任务就是插入/移动/替换/删除一些节点，然后创建一个新的抽象语法树（AST）用来生成代码。
<a name="MHDXS"></a></p> <h2 id="安装">安装</h2> <p>开始之前确保你安装了 <code>node</code> 和 <code>npm</code>，然后创建一个项目目录，添加文件 <code>package.json</code>，并安装开发环境下的依赖。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mkdir moriscript &amp;&amp; cd moriscript
npm init -y
npm install --save-dev babel-core
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>此时，我们为插件创建一个文件，内容为导出一个默认的函数：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// moriscript.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>babel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> t <span class="token operator">=</span> babel<span class="token punctuation">.</span>types<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    visitor<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这个函数给 <a href="https://en.wikipedia.org/wiki/Visitor_pattern" target="_blank" rel="noopener noreferrer">visitor pattern<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 导出了一个接口，我们后续再来介绍它。<br>最后，我们创建一个测试插件的运行器。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// run.js</span>
<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> babel <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'babel-core'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> moriscript <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./moriscript'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// read the filename from the command line arguments</span>
<span class="token keyword">var</span> fileName <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// read the code from this file</span>
fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
  <span class="token comment">// convert from a buffer to a string</span>
  <span class="token keyword">var</span> src <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// use our plugin to transform the source</span>
  <span class="token keyword">var</span> out <span class="token operator">=</span> babel<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>moriscript<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// print the generated code to screen</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>out<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>我们通过指定 MoriScript 文件来运行这个脚本，用来检查生成的 JavaScript 代码是不是我们期望的。如：<code>node run.js example.ms</code> <a name="gITfa"></a></p> <h2 id="数组">数组</h2> <p>MoriScript 首要和最重要的目标就是将普通对象和数组字面量转换为 Mori 对应的部分：HashMaps and Vectors。我们先来看看数组，它会相对简单一些：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> bar <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// should become</span>
<span class="token keyword">var</span> bar <span class="token operator">=</span> mori<span class="token punctuation">.</span><span class="token function">vector</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>拷贝上面的代码到 <a href="https://astexplorer.net/" target="_blank" rel="noopener noreferrer">astexplorer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，选中数组字面量 <code>[1, 2, 3]</code>，查看对应的抽象语法树（AST）节点。<br><em>为了更好的可读性，我们忽略了元数据字段，因为我们不用关心它</em></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
  &quot;type&quot;: &quot;ArrayExpression&quot;,
  &quot;elements&quot;: [
    {
      &quot;type&quot;: &quot;NumericLiteral&quot;,
      &quot;value&quot;: 1
    },
    {
      &quot;type&quot;: &quot;NumericLiteral&quot;,
      &quot;value&quot;: 2
    },
    {
      &quot;type&quot;: &quot;NumericLiteral&quot;,
      &quot;value&quot;: 3
    }
  ]
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>现在我们对 <code>mori.vector(1, 2, 3)</code> 进行相同的操作。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
  &quot;type&quot;: &quot;CallExpression&quot;,
  &quot;callee&quot;: {
    &quot;type&quot;: &quot;MemberExpression&quot;,
    &quot;object&quot;: {
      &quot;type&quot;: &quot;Identifier&quot;,
      &quot;name&quot;: &quot;mori&quot;
    },
    &quot;property&quot;: {
      &quot;type&quot;: &quot;Identifier&quot;,
      &quot;name&quot;: &quot;vector&quot;
    }
  },
  &quot;arguments&quot;: [
    {
      &quot;type&quot;: &quot;NumericLiteral&quot;,
      &quot;value&quot;: 1
    },
    {
      &quot;type&quot;: &quot;NumericLiteral&quot;,
      &quot;value&quot;: 2
    },
    {
      &quot;type&quot;: &quot;NumericLiteral&quot;,
      &quot;value&quot;: 3
    }
  ]
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>如果我们通过可视化方式看的话，可以更好的看到 2 个语法树之间需要修改的部分。<br><img src="https://cdn.nlark.com/yuque/0/2019/png/128853/1565281206762-1bfc081e-1122-46dc-bb33-d7406a7e40b2.png#align=left&amp;display=inline&amp;height=415&amp;originHeight=415&amp;originWidth=900&amp;size=0&amp;status=done&amp;width=900" alt=""><br>现在我们可以非常清晰的看到我们需要替换顶层的表达式，同时要保留 2 个语法数之间共同的数值字面量。<br>我们给 visitor 对象添加 <code>ArrayExpression</code> 方法。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>babel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> t <span class="token operator">=</span> babel<span class="token punctuation">.</span>types<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    visitor<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      ArrayExpression<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>当 Babel 遍历抽象语法树（AST）时，它会查看每一个节点。当发现插件里 visitor 对象上有相应的方法时，会调用这个方法，并将上下文传递进去。所以我们可以进行分析或者替换操作。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ArrayExpression<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>
    t<span class="token punctuation">.</span><span class="token function">callExpression</span><span class="token punctuation">(</span>
      t<span class="token punctuation">.</span><span class="token function">memberExpression</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">'mori'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">'vector'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>elements
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>我们可以通过 babel-types 模块的文档 <a href="https://github.com/babel/babel/tree/master/packages/babel-types#babel-types" target="_blank" rel="noopener noreferrer">documentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 查看每个表达式的类型。在这个例子下，我们可需要将 <code>ArrayExpression</code> 替换为 <code>CallExpression</code>，它可以通过 <code>t.callExpression(callee, arguments)</code> 来生成。实际上需要调用的是 <code>MemberExpression</code>，后者可以通过 <code>t.memberExpression(object, property)</code> 来生成。<br><em>同样地，你可以在网站 <a href="https://astexplorer.net/" target="_blank" rel="noopener noreferrer">astexplorer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 上运行，点击 “transform” 下拉菜单，然后选择 “babelv6”</em> <a name="QZJac"></a></p> <h2 id="对象">对象</h2> <p>接下来我们来看看对象：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token punctuation">{</span> bar<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// should become</span>
<span class="token keyword">var</span> foo <span class="token operator">=</span> mori<span class="token punctuation">.</span><span class="token function">hashMap</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>对象字面量和前面的 <code>ArrayExpression</code> 含有类似的结构。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;ObjectExpression&quot;</span><span class="token punctuation">,</span>
  <span class="token string">&quot;properties&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;ObjectProperty&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;key&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Identifier&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;name&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;bar&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">&quot;value&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;NumericLiteral&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;value&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>这个相当直白，properties 是个数组，每个元素都包含一个 key 和 一个 value。现在选中 <code>mori.hashMap('bar', 1)</code> 然后看相对应生成的结构是如何构成的。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>{
  &quot;type&quot;: &quot;CallExpression&quot;,
  &quot;callee&quot;: {
    &quot;type&quot;: &quot;MemberExpression&quot;,
    &quot;object&quot;: {
      &quot;type&quot;: &quot;Identifier&quot;,
      &quot;name&quot;: &quot;mori&quot;
    },
    &quot;property&quot;: {
      &quot;type&quot;: &quot;Identifier&quot;,
      &quot;name&quot;: &quot;hashMap&quot;
    }
  },
  &quot;arguments&quot;: [
    {
      &quot;type&quot;: &quot;StringLiteral&quot;,
      &quot;value&quot;: &quot;bar&quot;
    },
    {
      &quot;type&quot;: &quot;NumericLiteral&quot;,
      &quot;value&quot;: 1
    }
  ]
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>同样地，我们通过可视化的方式看看抽象语法树（AST）。<br><img src="https://cdn.nlark.com/yuque/0/2019/png/128853/1565281206770-ca69aab5-e3ba-4bcc-aa64-00d4739ea912.png#align=left&amp;display=inline&amp;height=416&amp;originHeight=416&amp;originWidth=780&amp;size=0&amp;status=done&amp;width=780" alt=""><br>像之前一样，<code>CallExpression</code> 里面包含了 <code>MemberExpression</code>，这个可以从上面数组的代码里借用。但是为了将属性和值放在一个扁平化的数组里我们需要做一点复杂的事情。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ObjectExpression<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> props <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    props<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
      t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>prop<span class="token punctuation">.</span>key<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
      prop<span class="token punctuation">.</span>value<span class="token punctuation">.</span>value
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>
    t<span class="token punctuation">.</span><span class="token function">callExpression</span><span class="token punctuation">(</span>
      t<span class="token punctuation">.</span><span class="token function">memberExpression</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">'mori'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">'hashMap'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      props
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>这个实现跟数组的实现方式非常类似，除了我们不得不将 <code>Identifier</code> 转换为 <code>StringLiteral</code> 以防止最终得到的代码类似于：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// before</span>
<span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token punctuation">{</span> bar<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// after</span>
<span class="token keyword">var</span> foo <span class="token operator">=</span> mori<span class="token punctuation">.</span><span class="token function">hashMap</span><span class="token punctuation">(</span>bar<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>最后，我们创建一个助手函数迁去创建 Mori <code>MemberExpressions</code> 好让我们能继续使用。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">moriMethod</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> t<span class="token punctuation">.</span><span class="token function">memberExpression</span><span class="token punctuation">(</span>
    t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">'mori'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// now rewrite</span>
t<span class="token punctuation">.</span><span class="token function">memberExpression</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">'mori'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">'methodName'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// as</span>
<span class="token function">moriMethod</span><span class="token punctuation">(</span><span class="token string">'methodName'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>现在我们可以创建并运行一些测试用例，看看插件是否正常工作：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>mkdir test
echo -e &quot;var foo = { a: 1 };\nvar baz = foo.a = 2;&quot; &gt; test/case.ms
node run.js test/case.ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>你可以在终端下看到类似下面的信息：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>var foo = mori.hashMap(&quot;a&quot;, 1);
var baz = foo.a = 2;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><a name="o6DEe"></a></p> <h2 id="赋值">赋值</h2> <p>为了让新的 Mori 数据结构有效，我们需要将新的属性覆盖到原生的语法结构上。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>foo<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token comment">// needs to become</span>
mori<span class="token punctuation">.</span><span class="token function">assoc</span><span class="token punctuation">(</span>foo<span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这次我们就不再给出抽象语法树（AST），只看图示和插件代码，但你自己可以通过<a href="https://astexplorer.net/" target="_blank" rel="noopener noreferrer">astexplorer<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 来查看相应的抽象语法树（AST）。<br><img src="https://cdn.nlark.com/yuque/0/2019/png/128853/1565281206714-85e6c1c8-9c9e-4adf-a1bc-b74b92e34c1a.png#align=left&amp;display=inline&amp;height=418&amp;originHeight=418&amp;originWidth=897&amp;size=0&amp;status=done&amp;width=897" alt=""><br>我们需要展开并转换节点，将每一个 <code>AssignmentExpression</code> 变成想要的 <code>CallExpression</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>AssignmentExpression<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> lhs <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>left<span class="token punctuation">;</span>
  <span class="token keyword">var</span> rhs <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>right<span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isMemberExpression</span><span class="token punctuation">(</span>lhs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isIdentifier</span><span class="token punctuation">(</span>lhs<span class="token punctuation">.</span>property<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      lhs<span class="token punctuation">.</span>property <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>lhs<span class="token punctuation">.</span>property<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>
      t<span class="token punctuation">.</span><span class="token function">callExpression</span><span class="token punctuation">(</span>
        <span class="token function">moriMethod</span><span class="token punctuation">(</span><span class="token string">'assoc'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span>lhs<span class="token punctuation">.</span>object<span class="token punctuation">,</span> lhs<span class="token punctuation">.</span>property<span class="token punctuation">,</span> rhs<span class="token punctuation">]</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p><code>AssignmentExpressions</code> 处理方法先是初步检测表达式左侧是否有 <code>MemberExpression</code>（因为我们不希望类似 <code>var a = 3</code> 混淆进去），然后替换为 <code>CallExpression</code>，它通过 Mori <code>assoc</code> 方法创建的。<br>像之前一样，我们处理使用了 <code>Identifier</code> 的地方，将其转换为 <code>StringLiteral</code>。<br>现在创建另一个测试用例来检查代码是否正常工作：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>echo -e &quot;foo.bar = 3;&quot; &gt;&gt; test/case.ms
node run.js test/case.ms
$ mori.assoc(foo, &quot;bar&quot;, 3);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><a name="kak9N"></a></p> <h2 id="成员">成员</h2> <p>最后，我们需要替换访问一个对象的原生语法：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>foo<span class="token punctuation">.</span>bar<span class="token punctuation">;</span>
<span class="token comment">// needs to become</span>
mori<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>foo<span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这里是 2 个可视化的抽象语法树（AST）。<br><img src="https://cdn.nlark.com/yuque/0/2019/png/128853/1565281206786-0c52275b-7e79-49da-ab35-eba61ffb0ec6.png#align=left&amp;display=inline&amp;height=411&amp;originHeight=411&amp;originWidth=704&amp;size=0&amp;status=done&amp;width=704" alt=""><br>我们差不多可以直接使用 <code>MemberExpression</code> 属性，然后当属性是个 <code>Identifier</code> 的时候，需要将其转换。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>MemberExpression<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isAssignmentExpression</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isIdentifier</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>property<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>property <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>property<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>
    t<span class="token punctuation">.</span><span class="token function">callExpression</span><span class="token punctuation">(</span>
      <span class="token function">moriMethod</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">[</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>object<span class="token punctuation">,</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>property<span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>首先最重要的一个不同点是当父级节点是 <code>AssignmentExpression</code> 时需要尽早的结束函数执行，这是因为我们希望 <code>AssignmentExpression</code> 访问器处理这些情况。<br>这看起来比较美好，当你运行这个代码的时候，你会发现出现堆栈溢出错误。这是因为使用 <code>mori.get</code> 替换 <code>MemberExpression</code>(<code>foo.bar</code>) 时，Babel 会遍历这个新的节点，并且重新递归的访问 <code>MemberExpression</code> 这个方法。<br>为了避免出现这个情况，我们可以对 <code>moriMethod</code> 返回值进行标记，然后在 <code>MemberExpression</code> 方法里根据标记进行忽略。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">moriMethod</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> expr <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">memberExpression</span><span class="token punctuation">(</span>
    t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span><span class="token string">'mori'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  expr<span class="token punctuation">.</span>isClean <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> expr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>一旦被标记后，函数内部可以添加另一个返回判断条件。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>MemberExpression<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>isClean<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isAssignmentExpression</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>创建最后一个测试用例，编译代码并且检查是否正常工作。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>echo -e &quot;foo.bar&quot; &gt;&gt; test/case.ms
node run.js test/case.ms
$ mori.get(foo, &quot;bar&quot;);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>如果一切顺利的话，现在你会了一门类似于 JavaScript 的语言。不同的是，在不影响原来语法的情况下，默认就有了不可变的数据结构。
<a name="dMeED"></a></p> <h2 id="结尾">结尾</h2> <p>这是一篇偏重代码的文章，但是覆盖到了所有设计和构建 Babel 插件的基础，可以作为一种有效的方式用来转换 JavaScript 文件。你可以通过 REPL <a href="https://danprince.github.io/moriscript/" target="_blank" rel="noopener noreferrer">here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的方式来使用 MoriScript，完整的代码可以在 <a href="https://github.com/sitepoint-editors/moriscript" target="_blank" rel="noopener noreferrer">on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 找到。<br>如果你想更深入的了解 Babel 插件，你可以检出 GitHub 上仓库代码 <a href="https://github.com/thejameskyle/babel-handbook" target="_blank" rel="noopener noreferrer">Babel Handbook<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 和 <a href="https://github.com/RReverser/babel-plugin-hello-world" target="_blank" rel="noopener noreferrer">babel-plugin-hello-world<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，还可以通过阅读更多的插件源代码 <a href="https://www.npmjs.com/search?q=babel-plugin" target="_blank" rel="noopener noreferrer">700+ Babel plugins already on npm<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。同样地还有创建插件的脚手架 <a href="https://www.npmjs.com/package/generator-babel-plugin" target="_blank" rel="noopener noreferrer">Yeoman generator<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。<br>希望这篇文章可以激发你去创建 Babel 插件。在你去实施下一个转译语言之前，这里有一些比较接地气的规则需要关注。Babel 是一个 JavaScript 到 JavaScript 的编译器，这意味着不能将 CoffeeScript 写成一个 Babel 插件。<strong>我们只能转换 <a href="https://github.com/babel/babylon" target="_blank" rel="noopener noreferrer">Babel’s parser<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 可以理解的 JavaScript 超集</strong>。<br>建议你通过 novel 插件来开始，你可以使用二进制操作符 <code>|</code> 创建一个函数式管道，类似于 F#, Elm 和 LiveScript 语言里的功能。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token number">2</span> <span class="token operator">|</span> double <span class="token operator">|</span> square
<span class="token comment">// would become</span>
<span class="token function">square</span><span class="token punctuation">(</span><span class="token function">double</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>或者内置一个箭头函数：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">doubleAndSquare</span> <span class="token operator">=</span> x <span class="token operator">=&gt;</span> x <span class="token operator">|</span> double <span class="token operator">|</span> square
<span class="token comment">// would become</span>
<span class="token keyword">const</span> <span class="token function-variable function">doubleAndSquare</span> <span class="token operator">=</span> x <span class="token operator">=&gt;</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token function">double</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// then use babel-preset-es2015</span>
<span class="token keyword">var</span> <span class="token function-variable function">doubleAndSquare</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">doubleAndSquare</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">square</span><span class="token punctuation">(</span><span class="token function">double</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>一旦你理解了这些规则，唯一的限制就是解析器和你的想象力。</p> <hr></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/zhenquan321/node-ts-dome.git/edit/master/src/offer/babelPlugin.md" target="_blank" rel="noopener noreferrer">Found a bug? Help me improve this page!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/offer/webpackLoader.html" class="prev">
          webpack loader实现
        </a></span> <span class="next"><a href="/offer/security.html">
          前端安全面试题
        </a>
        →
      </span></p></div> </div> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f01571a1.js" defer></script><script src="/assets/js/4.d35f8dd4.js" defer></script><script src="/assets/js/81.17c51564.js" defer></script>
  </body>
</html>
